<!DOCTYPE html>
<html lang="en">
<head>
  <title>Service Workers</title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <script
    src="../assets/web-spec-framework/bower_components/platform/platform.js">
  </script>
  <link rel="import"
      href="../assets/web-spec-framework/framework.html"/>
  <script src="../assets/scripts/spec-assist.js"></script>
  <meta name="bug.short_desc" content="[ServiceWorker]: ">
  <meta name="bug.product" content="WebAppsWG">
  <meta name="bug.component" content="ServiceWorker">
</head>
<body>

<div class="head">
  <div class="logo">
    <a href="//www.w3.org/"><img width="72" height="48" src="//www.w3.org/Icons/w3c_home" alt="W3C"></a>
  </div>

  <h1>Service Workers</h1>
  <h2 id="editors-draft">W3C Editor's Draft</h2>
  <dl>
  <dt>This version</dt>
    <dd><a href="https://slightlyoff.github.io/ServiceWorker/spec/service_worker/">https://slightlyoff.github.io/ServiceWorker/spec/service_worker/</a></dd>
  <dt>Latest editor's draft</dt>
    <dd><a href="https://slightlyoff.github.io/ServiceWorker/spec/service_worker/">https://slightlyoff.github.io/ServiceWorker/spec/service_worker/</a></dd>
  <dt>Previous version</dt>
    <dd><a href="http://www.w3.org/TR/service-workers/">http://www.w3.org/TR/service-workers/</a></dd>
  <dt>Revision history</dt>
    <dd><a id="log" href="https://github.com/slightlyoff/ServiceWorker/commits/master">https://github.com/slightlyoff/ServiceWorker/commits/master</a></dd>
  <dt>Participate</dt>
    <dd>Discuss on <a href="http://lists.w3.org/Archives/Public/public-webapps/">public-webapps@w3.org</a> (<a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a>)</dd>
    <dd><a href="https://github.com/slightlyoff/ServiceWorker/issues">File bugs</a></dd>
  <dt>Editors</dt>
    <dd class="vcard"><span class="fn">Alex Russell</span>, <span class="org">Google</span>, &lt;<a class="email" href="mailto:slightlyoff@chromium.org">slightlyoff@chromium.org</a>&gt;</dd>
    <dd class="vcard"><span class="fn">Jungkee Song</span>, <span class="org">Samsung Electronics</span>, &lt;<a class="email" href="mailto:slightlyoff@chromium.org">jungkee.song@samsung.com</a>&gt;</dd>
  </dl>

  <p class="copyright">
    <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> &copy; 2014 <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>&copy;</sup> (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href="http://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href="http://www.keio.ac.jp/">Keio</a>, <a href="http://ev.buaa.edu.cn/">Beihang</a>), All Rights Reserved. <abbr title="World Wide Web Consortium">W3C</abbr> <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a> rules apply.
  </p>

  <hr>

  <h2 id="abstract">Abstract</h2>

  <p>This specification describes a method that enables applications to take advantage of persistent background processing, including hooks to enable bootstrapping of web applications while offline.</p>

  <p>The core of this system is an event-driven <a href="http://www.w3.org/TR/workers/">Web Worker</a>, which responds to events dispatched from documents and other sources. A system for managing installation, versions, and upgrades is provided.</p>

  <p>The Service Worker is a generic entry point for event-driven background processing in the Web Platform that is <a href="#extensibility">extensible by other specifications</a>.</p>

  <h2 id="status">Status of This Document</h2>

  <p><em>This section describes the status of this document at the time of its publication. Other documents may supersede this document. A list of current <abbr title="World Wide Web Consortium">W3C</abbr> publications and the latest revision of this technical report can be found in the <a href="http://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr> technical reports index</a> at http://www.w3.org/TR/.</em></p>

  <p>This document was published by the <a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a> as an Editor's Draft. If you wish to make comments regarding this document, please send them to <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a> (<a href="mailto:public-webapps-request@w3.org?subject=subscribe">subscribe</a>, <a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>). All feedback is welcome.</p><p>Publication as an Editor's Draft does not imply endorsement by the <abbr title="World Wide Web Consortium">W3C</abbr> Membership. This is a draft document and may be updated, replaced or obsoleted by other documents at any time. It is inappropriate to cite this document as other than work in progress.</p>

  <p>This document was produced by a group operating under the <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>. <abbr title="World Wide Web Consortium">W3C</abbr> maintains a <a href="http://www.w3.org/2004/01/pp-impl/42538/status" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group; that page also includes instructions for disclosing a patent. An individual who has actual knowledge of a patent which the individual believes contains <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section 6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>.</p>
</div>

<spec-toc></spec-toc>

<spec-clause id="introduction">
  <h1>Introduction</h1>

  <spec-section id="about">
    <h1>About this Document</h1>

    <p>All diagrams, examples, notes, are non-normative, as well as sections explicitly marked as non-normative. Everything else in this specification is normative.</p>

    <p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in the normative parts of this document are to be interpreted as described in <a href="http://dev.w3.org/2006/xbl2/#refsRFC2119">RFC2119</a>. For readability, these words do not appear in all uppercase letters in this specification.</p>

    <p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="http://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>
  </spec-section>

  <spec-section id="dependencies">
    <h1>Dependencies</h1>

    <p>This document relies on the following specifications:</p>

    <ul>
      <li><a href="http://www.w3.org/TR/workers/">Web Workers</a></li>
      <li><a href="http://fetch.spec.whatwg.org/">Fetch Living Standard</a></li>
      <li><a href="http://dom.spec.whatwg.org/">DOM Living Standard</a></li>
      <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">HTML Living Standard</a></li>
      <li><a href="http://ecma-international.org/ecma-262/5.1/">ECMAScript Language Specification</a></li>
      <li><a href="http://www.w3.org/TR/WebIDL/">Web IDL</a></li>
      <li><a href="http://www.w3.org/TR/IndexedDB/">Indexed DB</a></li>
      <li><a href="http://www.w3.org/TR/quota-api/">Quota Management API</a></li>
      <li><a href="http://www.w3.org/TR/notifications/">Web Notifications</a></li>
      <li><a href="http://tools.ietf.org/html/rfc6454">The Web Origin Concept</a></li>
      <li><a href="http://url.spec.whatwg.org/">URL Living Standard</a></li>
      <li><a href="http://tools.ietf.org/html/rfc2616">Hypertext Transfer Protocol -- HTTP/1.1</a></li>
      <li><a href="http://www.w3.org/TR/mixed-content/">Mixed Content</a></li>
    </ul>
  </spec-section>

  <spec-section class="informative" id="motivations">
    <h1>Motivations</h1>

    <p>Web Applications traditionally assume that the network is reachable. This assumption pervades the platform. HTML documents are loaded over HTTP and traditionally fetch all of their sub-resources via subsequent HTTP requests. This places web content at a disadvantage versus other technology stacks.</p>

    <p>The Service Worker is designed first to redress this balance by providing a Web Worker context, which can be started by a runtime when navigations are about to occur. This event-driven worker is registered against an origin and a path (or pattern), meaning it can be consulted when navigations occur to that location. Events that correspond to network requests are dispatched to the worker and the responses generated by the worker may over-ride default network stack behavior. This puts the Service Worker, conceptually, between the network and a document renderer, allowing the Service Worker to provide content for documents, even while offline.</p>

    <p>Web developers familiar with previous attempts to solve the offline problem have reported a deficit of flexibility in those solutions. As a result, the Service Worker is highly procedural, providing a maximum of flexibility at the price of additional complexity for developers. Part of this complexity arises from the need to keep Service Workers responsive in the face of a single-threaded execution model. As a result, APIs exposed by Service Workers are almost entirely asynchronous, a pattern familiar in other JavaScript contexts but accentuated here by the need to avoid blocking document and resource loading.</p>

    <p>Developers using the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/offline.html">HTML5 Application Cache</a> have also <a href="http://alistapart.com/article/application-cache-is-a-douchebag">reported that several attributes</a> of the design contribute to <a href="http://alistapart.com/article/application-cache-is-a-douchebag#section6">unrecoverable errors</a>. A key design principle of the Service Worker is that errors should <em>always</em> be recoverable. Many details of the update process of Service Workers are designed to avoid these hazards.</p>

    <p>Service Workers are started and kept alive by their relationship to events, not documents. This design borrows heavily from developer and vendor experience with <a href="http://www.w3.org/TR/workers/#sharedworker">Shared Workers</a> and <a href="https://developer.chrome.com/extensions/background_pages">Chrome Background Pages</a>. A key lesson from these systems is the necessity to time-limit the execution of background processing contexts, both to conserve resources and to ensure that background context loss and restart is top-of-mind for developers. As a result, Service Workers bear more than a passing resemblance to <a href="https://developer.chrome.com/extensions/event_pages">Chrome Event Pages</a>, the successor to Background Pages. Service Workers may be started by user agents <em>without an attached document</em> and may be killed by the user agent at nearly any time. Conceptually, Service Workers can be thought of as Shared Workers that can start, process events, and die without ever handling messages from documents. Developers are advised to keep in mind that Service Workers may be started and killed many times a second.</p>

    <p>Service Workers are generic, event-driven, time-limited script contexts that run at an origin. These properties make them natural endpoints for a range of runtime services that may outlive the context of a particular document, e.g. handling push notifications, background data synchronization, responding to resource requests from other origins, or receiving centralized updates to expensive-to-calculate data (e.g., geolocation or gyroscope).</p>
  </spec-section>
</spec-clause>

<spec-clause id="concepts">
  <h1>Concepts</h1>

  <p>A <dfn id="dfn-service-worker">Service Worker</dfn> is a type of <a href="http://www.w3.org/TR/workers/">Web Worker</a>. Unlike other types of <a href="http://www.w3.org/TR/workers/">Web Worker</a>, the lifetime of a <a href="#dfn-service-worker">Service Worker</a> is tied to the execution lifetime of events, not references held by documents to the <a href="#service-worker-obj">worker object</a>. In practice, this means that <a href="#dfn-service-worker">Service Workers</a> may begin, end, and restart execution many times over the life of documents which they logically <a href="#dfn-document-control">control</a>.</p>

  <p>Service Workers are <a href="#installation-algorithm">installed</a> by user agents after being <a href="#navigator-service-worker-register">registered</a> by authors from the context of a <a href="http://dom.spec.whatwg.org/#concept-document">document</a>. Service Workers execute in the registering document's <a href="http://goo.gl/58tlSE">origin</a>.</p>

  <p>A <dfn id="dfn-registration">registration</dfn> maps a <a href="#dfn-service-worker">Service Worker</a> script to <dfn id="dfn-url-scope">URL scope</dfn>, a tuple of <a href="http://tools.ietf.org/html/rfc6454">origin</a> and <a href="#dfn-path-prefix">path prefix</a>. User agents may enable many registrations at a single origin so long as the <a href="#dfn-path-prefix">path prefix</a> of the registration differs. <a href="#dfn-registration">Registration</a> of an identical <a href="http://tools.ietf.org/html/rfc6454">origin</a>/<a href="#dfn-path-prefix">path prefix</a> when one already exists in the user agent causes the existing registration to be replaced.</p>

  <p>A <dfn id="dfn-path-prefix">path prefix</dfn> consists of a <a href="http://url.spec.whatwg.org/#concept-relative-url">relative URL</a>.</p>

  <p>A <a href="#dfn-registration">registration</a> may have an associated <dfn id="dfn-installing-worker" title="Installing Worker">installing worker</dfn> when the <a href="#dfn-registration">registration</a> has entered and is running the steps in the <a href="#dfn-installation-process">installation process</a>. A <a href="#dfn-registration">registration</a> may have an an associated <dfn id="dfn-active-worker" title="Active Worker">active worker</dfn> when the <a href="#dfn-registration">registration</a> has entered (or may have completed) the <a href="#dfn-activation-process">activation process</a>.</p>

  <p>A document is <dfn id="dfn-document-control">controlled</dfn> if an <a href="#dfn-active-worker">active worker</a> <a href="#scope-match-algorithm">matches</a> the document's URL upon <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/history.html#navigate">navigation</a>. Multiple documents may be concurrently <a href="#dfn-document-control">controlled</a> by a single <a href="#dfn-service-worker">Service Worker</a> instance. That is, <a href="#dfn-service-worker">Service Workers</a> have a one-to-many relationship with <a href="#dfn-document-control">controlled</a> documents. When a document is <a href="#dfn-document-control">controlled</a> by a <a href="#dfn-service-worker">Service Worker</a>, it is considered the document is <dfn id="dfn-document-use">using</dfn> the <a href="#dfn-service-worker">Service Worker</a>'s associated <a href="#dfn-registration">registration</a>.</p>

  <p>The <dfn id="dfn-lifecycle-events">lifecycle events</dfn> of Service Workers are <code><a href="#install-event">install</a></code> and <code><a href="#activate-event">activate</a></code>. <dfn id="dfn-functional-events">Functional events</dfn> are <a href="http://dom.spec.whatwg.org/#interface-event">DOM Events</a> that are dispatched in the <a href="#service-worker-global-scope">Service Worker global context</a> which are not <a href="#dfn-lifecycle-events">lifecycle events</a> of the Service Worker.</p>

  <p>Registered Service Workers do not immediately begin to receive <a href="#dfn-functional-events">functional events</a> for documents. <a href="#register-algorithm">Registration</a> is the first step in installation, which proceeds through several phases:</p>

  <ol>
    <li><em>Fetch</em>:
    <br>
    The script URL provided by the author (via a call to <code><a href="#navigator-service-worker-register">navigator.serviceWorker.register(<var>scriptURL</var>, <var>options</var>)</a></code> from a document) is fetched without <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html#sec13.2.2">heuristic caching</a>. If the return status code of the fetch is not <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2">2xx</a>, installation aborts.</li>
    <li><em>Startup</em>:
    <br>
    If fetching the worker script is successful, it is <a href="http://www.w3.org/TR/workers/#processing-model">executed</a> in a <code><a href="#service-worker-global-scope">ServiceWorkerGlobalScope</a></code>. These scripts may call <code><a href="http://www.w3.org/TR/workers/#importing-scripts-and-libraries">importScripts</a></code> resulting in further fetches. Imported scripts are fetched, <a href="https://people.mozilla.org/~jorendorff/es5.1-final.html#sec-5.1.4">parsed</a> and <a href="https://people.mozilla.org/~jorendorff/es5.1-final.html#sec-10.4.1">executed</a> in turn, per the ECMA-262 and <a href="http://www.w3.org/TR/workers/#importing-scripts-and-libraries">Web Workers specifications</a>. All resources downloaded as part of the very first startup of a Service Worker are cached along with the worker script as described in <a href="#update-algorithm">"Worker Script Caching"<!--TODO(jungkees): add worker script caching section--></a>.
    </li>
    <li><code><a href="#service-worker-global-scope-oninstall-attribute"><em>oninstall</em></a></code>:
    <br>
    Once a Service Worker has been fetched and started, it is ready to process <a href="http://dom.spec.whatwg.org/#interface-event">events</a>. The first event sent to every <a href="#dfn-service-worker">Service Worker</a> is <code><a href="#service-worker-global-scope-install-event">install</a></code>. Workers that handle this event are encouraged to use it as a way to prime the available storage mechanisms for supporting offline application use; perhaps by populating <a href="http://www.w3.org/TR/IndexedDB/">IndexedDB databases</a> or <code><a href="#cache-interface">Cache</a></code> objects.
    <br><br>
    Service Workers are not considered "installed" until the <code><a href="#service-worker-global-scope-oninstall-attribute">oninstall</a></code> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handlers">event handler</a> completes. Given that many tasks, such as populating caches, may take a long time and are asynchronous, <a href="#wait-until-method">mechanisms are provided</a> to let applications signal to the user agent when they consider themselves prepared to handle further events.
    <br><br>
    If no <code><a href="#service-worker-global-scope-oninstall-attribute">oninstall</a></code> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handlers">event handler</a> is registered, the Service Worker is considered to be successfully installed.
    <br><br>
    If any <code><a href="#service-worker-global-scope-oninstall-attribute">oninstall</a></code> handler <a href="http://dom.spec.whatwg.org/#concept-throw">throws</a> an exception, or if any lifetime extension via <code><a href="#install-phase-event-waituntil-method">event.waitUntil()</a></code> fails (via promise rejection), installation fails and activation is not carried out.
    <br><br>
    Assuming an <a href="#dfn-installing-worker">installing worker</a> completes the steps in the <a href="#dfn-installation-process">installation process</a> (i.e. successfully installed), it is now considered the <dfn id="dfn-worker-in-waiting">worker in waiting</dfn>. There may be only one <a href="#dfn-active-worker">active worker</a>, one <a href="#dfn-worker-in-waiting">worker in waiting</a> and one <a href="#dfn-installing-worker">installing worker</a> for a given <a href="#dfn-url-scope">URL scope</a>.
    </li>
    <li><code><a href="#service-worker-global-scope-onactivate-attribute"><em>onactivate</em></a></code>:
    <br>
    After successful installation and just prior to receiving <a href="#dfn-functional-events">functional events</a> (e.g., <code><a href="#fetch-event">fetch</a></code>), the <code>activate</code> event is dispatched. The primary use of <code><a href="#service-worker-global-scope-onactivate-attribute">onactivate</a></code> is for cleanup of resources used in previous versions of a Service Worker script.
    <br><br>
    <div class="note">Like <code><a href="#service-worker-global-scope-install-event">install</a></code> event, this event may extend its lifetime using <code><a href="#install-phase-event-waituntil-method">event.waitUntil()</a></code>, however developers should note that activation is particularly performance sensitive. Performance sensitive events may be queued and will be delayed until successful completion of <code><a href="#service-worker-global-scope-onactivate-attribute">onactivate</a></code>.</div>
    </li>
  </ol>

  <p>User Agents may request updated Service Worker scripts "in the background" while <a href="#dfn-document-control">controlled</a> documents for an existing Service Worker and URL scope are active. Successful fetch, startup, and <code><a href="#service-worker-global-scope-oninstall-attribute">oninstall</a></code> <i>do not</i> guarantee that the <a href="#dfn-worker-in-waiting">worker-in-waiting</a> will begin to immediately handle <a href="#dfn-functional-events">functional events</a>. An existing Service Worker script will continue to service documents it controls (and will continue to control new documents in the <a href="#dfn-url-scope">URL scope</a>) so long as any documents it <a href="#dfn-document-control">controlled</a> remain. API exists on the <a href="#service-worker-obj">Service Worker</a> to enable immediate activation but this is not the default behavior.<p>

  <p>Once a Service Worker becomes active, the user agent may dispatch <a href="#dfn-functional-events">functional events</a>. These events model various user-agent generated operations; for example the <code><a href="#service-worker-global-scope-fetch-event">fetch</a></code> event handling HTTP requests.</p>

<!--
<spec-section>
<h1 id="offline-example">Example: Offline Web Applications</h1>

<spec-code class="prettyprint">
// TODO(slightlyoff)
</spec-code>

<p></p>
</spec-section>
-->

</spec-clause>

<spec-clause id="document-context">
  <h1>Document Context</h1>

  <p>Example: Bootstrapping with a ServiceWorker</p>

<spec-code class="prettyprint">// scope defaults to "/"
navigator.serviceWorker.register("/assets/v1/serviceworker.js").then(
  function(registration) {
    console.log("success!");
    if (registration.installing) {
      registration.installing.postMessage("Howdy from your installing page.");
      // To use the serviceWorker immediately, you might call window.location.reload()
    }
  },
  function(why) {
    console.error("Installing the worker failed!:", why);
  });</spec-code>

  <spec-section id="service-worker-obj">
    <h1><code>ServiceWorker</code></h1>

    <p></p>
<spec-idl>[Exposed=(Window,ServiceWorker)]
interface <dfn id="service-worker-interface" title="ServiceWorker">ServiceWorker</dfn> : <a href="http://goo.gl/mkHcfY">Worker</a> {
  readonly attribute <a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a> <a href="#service-worker-url-attribute">scriptURL</a>;
  readonly attribute <a href="#service-worker-state-enum">ServiceWorkerState</a> <a href="#service-worker-state-attribute">state</a>;

  // event
  attribute <a href="http://goo.gl/3nnYrx">EventHandler</a> <a href="#service-worker-onstatechange-attribute">onstatechange</a>;

  // terminate() method inherited from Worker <a href="#service-worker-terminate-method">should not be accessible</a>.
};

enum <dfn id="service-worker-state-enum" title="State">ServiceWorkerState</dfn> {
  "installing",
  "installed",
  "activating",
  "activated",
  "redundant"
};</spec-idl>

    <p>The <code><a href="#service-worker-interface">ServiceWorker</a></code> interface represents the document-side view of a <a href="#dfn-service-worker">Service Worker</a>.</p>

    <p>Each <code><a href="#service-worker-interface">ServiceWorker</a></code> object is associated with a <a href="#dfn-service-worker">Service Worker</a>. Multiple separate objects implementing the <code><a href="#service-worker-interface">ServiceWorker</a></code> interface across <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#document-environment">document environments</a> and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#worker-environment">service worker environments</a> can all be associated with the same <a href="#dfn-service-worker">Service Worker</a> simultaneously.</p>

    <p id="service-worker-terminate-method" class="note">The <code><a href="http://www.w3.org/TR/workers/#dom-worker-terminate">terminate()</a></code> method inherited from <code><a href="http://www.w3.org/TR/workers/#worker">Worker</a></code>, when called on the <a href="http://dom.spec.whatwg.org/#context-object">context object</a>, should throw an "<code><a href="http://dom.spec.whatwg.org/#invalidaccesserror">InvalidAccessError</a></code>" exception.</p>

    <spec-section id="service-worker-url">
      <h1><code>scriptURL</code></h1>

      <p>The <code><a href="#service-worker-url-attribute">scriptURL</a></code> of a <code><a href="#service-worker-interface">ServiceWorker</a></code> object reflects the script's URL of the associated <a href="#dfn-service-worker">Service Worker</a>.</p>

      <p>The <dfn id="service-worker-url-attribute"><code>scriptURL</code></dfn> attribute must return the result of running these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

      <spec-algorithm>
      <ol>
        <li>Let <var>scriptURL</var> be the URL of the script of the <a href="#dfn-service-worker">Service Worker</a> identifed by its <a href="#dfn-url-scope">URL scope</a>.</li>
        <li>Set <var>scriptURL</var> to the result of running the <a href="http://url.spec.whatwg.org/#concept-url-serializer">URL serializer</a> with <var>scriptURL</var>.</li>
        <li>Return <var>scriptURL</var>. Each <a href="http://www.whatwg.org/specs/web-apps/current-work/#document">Document</a> object or <code><a href="##service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> object must have a separate object for its <code><a href="#service-worker-interface">ServiceWorker</a></code>'s <code><a href="#service-worker-url-attribute">scriptURL</a></code> attribute.</li>
      </ol>
      </spec-algorithm>

      <p>For example, consider a document created by a navigation to <code>https://example.com/app.html</code> which <a href="#on-fetch-request-algorithm">matches</a> via the following registration call which has been previously executed:</p>

<spec-code class="prettyprint">// Script on the page https://example.com/app.html
navigator.serviceWorker.register("/service_worker.js", { scope: "/" });</spec-code>

      <p>The value of <code>navigator.serviceWorker.controller.scriptURL</code> will be "<code>https://example.com/service_worker.js</code>".</p>
    </spec-section>

    <spec-section id="service-worker-state">
      <h1><code>state</code></h1>

      <p>A <code><a href="#service-worker-interface">ServiceWorker</a></code> object can be in several states.</p>

      <p>The <dfn id="service-worker-state-attribute"><code>state</code></dfn> attribute must return the current state, which must be one of the following values defined in the <a href="#service-worker-state-enum">ServiceWorkerState</a> enumeration. Each <a href="http://www.whatwg.org/specs/web-apps/current-work/#document">Document</a> object or <code><a href="##service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> object must have a separate object for its <code><a href="#service-worker-interface">ServiceWorker</a></code>'s <code><a href="#service-worker-state-attribute">state</a></code> attribute.:</p>

      <dl>
        <dt>"<code>installing</code>"</dt>
        <dd>The Service Worker represented by the <code><a href="#service-worker-interface">ServiceWorker</a></code> object has entered and is running the steps in the <a href="#dfn-installation-process">installation process</a>. During this state, <code><a href="#install-phase-event-waituntil-method">event.waitUntil(<var>f</var>)</a></code> can be called inside the <code><a href="#service-worker-global-scope-oninstall-attribute">oninstall</a></code> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handlers">event handler</a> of the associated <a href="#service-worker-glober-scope-interface">ServiceWorkerGlobalScope</a> object to extend the life of the <a href="#dfn-installing-worker">installing worker</a> until the passed <a href="http://goo.gl/3TobQS">promise</a> resolves successfully. This is primarily used to ensure that the Service Worker is not active until all of the core caches are populated.</dd>
        <dt>"<code>installed</code>"</dt>
        <dd>The Service Worker represented by the <code><a href="#service-worker-interface">ServiceWorker</a></code> object has completed the steps in the <a href="#dfn-installation-process">installation process</a>. The Service Worker in this state is considered the <a href="#dfn-worker-in-waiting">worker in waiting</a>.</dd>
        <dt>"<code>activating</code>"</dt>
        <dd>The Service Worker represented by the <code><a href="#service-worker-interface">ServiceWorker</a></code> object has entered and is running the steps in the <a href="#dfn-activation-process">activation process</a>. During this state, <code><a href="#install-phase-event-waituntil-method">event.waitUntil(<var>f</var>)</a></code> can be called inside the <code><a href="#service-worker-global-scope-onactivate-attribute">onactivate</a></code> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handlers">event handler</a> of the associated <a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a> object to extend the life of the activating <a href="#dfn-active-worker">active worker</a> until the passed <a href="http://goo.gl/3TobQS">promise</a> resolves successfully. Note that no <a href="#dfn-functional-events">functional events</a> are dispatched until the state becomes "<code>activated</code>".</dd>
        <dt>"<code>activated</code>"</dt>
        <dd>The Service Worker represented by the <code><a href="#service-worker-interface">ServiceWorker</a></code> object has completed the steps in the <a href="#dfn-activation-process">activation process</a>. The Service Worker in this state is considered the <a href="#dfn-active-worker">active worker</a> ready to <a href="#dfn-document-control">control</a> the documents in matching scope upon subsequent <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/history.html#navigate">navigation</a>.</dd>
        <dt>"<code>redundant</code>"</dt>
        <dd>A newly created <a href="#dfn-registration">registration</a> is replacing the current <a href="#dfn-registration">registration</a>.</dd>
      </dl>
    </spec-section>

    <spec-section id="service-worker-event-handler">
      <h1>Event handler</h1>

      <p>The following is the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handlers">event handler</a> (and its corresponding <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handler-event-type">event handler event type</a>) that must be supported, as <a href="http://www.whatwg.org/specs/web-apps/current-work/#event-handler-idl-attributes">event handler IDL attributes</a>, by all objects implementing <code><a href="#service-worker-interface">ServiceWorker</a></code> interface. Each <a href="http://www.whatwg.org/specs/web-apps/current-work/#document">Document</a> object or <code><a href="##service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> object must have a separate object for its <code><a href="#service-worker-interface">ServiceWorker</a></code>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handlers">event handler</a>:</p>

      <table>
        <thead>
          <tr>
            <th><a href="http://www.whatwg.org/specs/web-apps/current-work/#event-handlers">event handler</a></th>
            <th><a href="http://www.whatwg.org/specs/web-apps/current-work/#event-handler-event-type">event handler event type</a></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><dfn id="service-worker-onstatechange-attribute"><code>onstatechange</code></dfn></td>
            <td><code><a href="#service-worker-statechange-event">statechange</a></code></td>
          </tr>
        </tbody>
      </table>
    </spec-section>
  </spec-section>

  <spec-section id="service-worker-registration-obj">
    <h1><code>ServiceWorkerRegistration</code></h1>

<spec-idl>[Exposed=Window]
interface <dfn id="service-worker-registration-interface" title="ServiceWorkerRegistration">ServiceWorkerRegistration</dfn> : <a href="http://dom.spec.whatwg.org/#eventtarget">EventTarget</a> {
  [<a href="http://heycam.github.io/webidl/#Unforgeable">Unforgeable</a>] readonly attribute <a href="#service-worker-interface">ServiceWorker</a>? <a href="#service-worker-registration-installing-attribute">installing</a>;
  [<a href="http://heycam.github.io/webidl/#Unforgeable">Unforgeable</a>] readonly attribute <a href="#service-worker-interface">ServiceWorker</a>? <a href="#service-worker-registration-waiting-attribute">waiting</a>;
  [<a href="http://heycam.github.io/webidl/#Unforgeable">Unforgeable</a>] readonly attribute <a href="#service-worker-interface">ServiceWorker</a>? <a href="#service-worker-registration-active-attribute">active</a>;

  readonly attribute <a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a> <a href="#service-worker-registration-scope-attribute">scope</a>;

  <a href="http://goo.gl/3TobQS">Promise</a>&lt;boolean&gt; <a href="#service-worker-registration-unregister-method">unregister</a>();

  // event
  attribute <a href="http://goo.gl/3nnYrx">EventHandler</a> <a href="#service-worker-registration-onupdatefound-attribute">onupdatefound</a>;
};</spec-idl>

    <p>The <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> interface represents a <a href="#dfn-registration">registration</a>. A <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> has <code><a href="#service-worker-registration-scope-attribute">scope</a></code>, a string that represents a <a href="#dfn-url-scope">URL scope</a>, <code><a href="#service-worker-registration-installing-attribute">installing</a></code>, a <a href="#service-worker-interface">ServiceWorker</a> object representing an <a href="#dfn-installing-worker">installing worker</a>, <code><a href="#service-worker-registration-waiting-attribute">waiting</a></code>, a <a href="#service-worker-interface">ServiceWorker</a> object representing a <a href="#dfn-worker-in-waiting">worker in wating</a> and <code><a href="#service-worker-registration-active-attribute">active</a></code>, a <a href="#service-worker-interface">ServiceWorker</a> object representing an <a href="#dfn-active-worker">active worker</a>.</p>

    <p>A <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> has internal properties <dfn id="script-url-internal-property">[[ScriptURL]]</dfn>, a string that represents the URL of the script for which the registration process (<a href="#register-algorithm">[[Register]]</a> algorithm) started, <dfn id="pending-registration-promise-internal-property">[[PendingRegistrationPromise]]</dfn>, a  <a href="http://goo.gl/3TobQS">promise</a> that captures the latest <a href="#register-algorithm">registration attempt</a> occurred during an ongoing <a href="#unregister-algorithm">unregistration process</a>, and <dfn id="upinstalling-internal-property">[[Uninstalling]]</dfn>, a boolean value that indicates whether a <a href="#dfn-registration">registration</a> is currently undergoing the unregistration process. (<a href="#unregister-algorithm">[[Unregister]]</a> algorithm.)</p>

    <p>Each <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object is associated with a <a href="#dfn-registration">registration</a>. Multiple separate objects implementing the <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> interface across <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#document-environment">document environments</a> can all be associated with the same <a href="#dfn-registration">registration</a> simultaneously.</p>

    <spec-section id="navigator-service-worker-installing">
      <h1><code>installing</code></h1>

      <p><dfn id="service-worker-registration-installing-attribute"><code>installing</code></dfn> attribute must return a <code><a href="#service-worker-interface">ServiceWorker</a></code> object representing the <a href="#dfn-installing-worker">installing worker</a> that is currently undergoing the <dfn id="dfn-installation-process">installation process</dfn> (from step 3 to step 12 of the <a href="#installation-algorithm">[[Install]]</a> algorithm) for the given <a href="#dfn-url-scope">URL scope</a> in which the document may be <a href="#dfn-document-control">controlled</a> when the Service Worker becomes the <a href="#dfn-active-worker">active worker</a>. <code><a href="#service-worker-registration-installing-attribute">navigator.serviceWorker.installing</a></code> returns <code>null</code> if no <a href="#service-worker-registration-internal-interface">registration</a> is in the <a href="#dfn-installation-process">installation process</a>. Each <a href="http://www.whatwg.org/specs/web-apps/current-work/#document">Document</a> object must have a separate object for its <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code>'s <code><a href="#service-worker-registration-installing-attribute">installing</a></code> attribute.</p>
    </spec-section>

    <spec-section id="navigator-service-worker-waiting">
      <h1><code>waiting</code></h1>

      <p><dfn id="service-worker-registration-waiting-attribute"><code>waiting</code></dfn> attribute must return a <code><a href="#service-worker-interface">ServiceWorker</a></code> object representing the waiting Service Worker that is considered the <a href="#dfn-worker-in-waiting">worker in waiting</a> for the document. <code><a href="#service-worker-registration-waiting-attribute">navigator.serviceWorker.waiting</a></code> returns <code>null</code> if there is no <a href="#dfn-worker-in-waiting">worker in waiting</a> for the document. Each <a href="http://www.whatwg.org/specs/web-apps/current-work/#document">Document</a> object must have a separate object for its <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code>'s <code><a href="#service-worker-registration-waiting-attribute">waiting</a></code> attribute.</p>
    </spec-section>

    <spec-section id="navigator-service-worker-active">
      <h1><code>active</code></h1>

      <p><dfn id="service-worker-registration-active-attribute"><code>active</code></dfn> attribute must return a <code><a href="#service-worker-interface">ServiceWorker</a></code> object representing the <a href="#dfn-active-worker">active worker</a> that is currently undergoing or completed the <dfn id="dfn-activation-process">activation process</dfn> (from step 5 to step 12 of the <a href="#activation-algorithm">[[Activate]]</a> algorithm) for the given <a href="#dfn-url-scope">URL scope</a> in which the document is <a href="#dfn-document-control">controlled</a> (or to be <a href="#dfn-document-control">controlled</a>). <code><a href="#service-worker-registration-active-attribute">navigator.serviceWorker.active</a></code> returns <code>null</code> if no <a href="#service-worker-registration-internal-interface">registration</a> is in the <a href="#dfn-activation-process">activation process</a>. Each <a href="http://www.whatwg.org/specs/web-apps/current-work/#document">Document</a> object must have a separate object for its <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code>'s <code><a href="#service-worker-registration-active-attribute">active</a></code> attribute.</p>
    </spec-section>

    <spec-section id="service-worker-registration-scope">
      <h1><code>scope</code></h1>

      <p>The <code><a href="#service-worker-registration-scope-attribute">scope</a></code> of a <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object reflects the <a href="#dfn-url-scope">URL scope</a> of the associated <a href="#dfn-service-worker">Service Worker</a>'s <a href="#dfn-registration">registration</a>.</p>

      <p>The <dfn id="service-worker-registration-scope-attribute"><code>scope</code></dfn> attribute must return the result of running these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

      <spec-algorithm>
      <ol>
        <li>Let <var>scope</var> be the URL representing the <a href="#dfn-url-scope">URL scope</a> of the associated <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object.</li>
        <li>Set <var>scope</var> to the result of running the <a href="http://url.spec.whatwg.org/#concept-url-serializer">URL serializer</a> with <var>scope</var>.</li>
        <li>Return <var>scope</var>. Each <a href="http://www.whatwg.org/specs/web-apps/current-work/#document">Document</a> object must have a separate object for its <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code>'s <code><a href="#service-worker-registration-scope-attribute">scope</a></code> attribute.</li>
      </ol>
      </spec-algorithm>

      <p>In the example in section 3.1.1, the value of <code>registration.scope</code>, obtained from <code>navigator.serviceWorker.ready.then(function(registration) { console.log(registration.scope); })</code> for example, will be "<code>https://example.com/</code>".</p>
    </spec-section>

    <spec-section id="navigator-service-worker-unregister">
      <h1><code>unregister()</code></h1>

      <p>The <code><a href="#service-worker-registration-unregister-method">unregister()</a></code> method unregisters the <a href="#dfn-registration">registration</a> for the given <a href="#dfn-url-scope">URL scope</a>. It is important to note that the currently <a href="#dfn-document-control">controlled</a> document's <a href="#dfn-registration">registration</a> is effective until all the documents (including itself) using this <a href="#dfn-registration">registration</a> unload. That is, <code><a href="#service-worker-registration-unregister-method">unregister()</a></code> method only affects subsequent <a href="http://www.whatwg.org/specs/web-apps/current-work/#navigate">navigations</a>.</p>

      <p><dfn id="service-worker-registration-unregister-method"><code>unregister()</code></dfn> method must return the result of running the <a href="#unregister-algorithm">[[Unregister]]</a> algorithm, or their <a href="#dfn-processing-equivalence">equivalent</a>, passing the associated document <var>document</var> and <code><a href="#service-worker-registration-scope-attribute">scope</a></code>, which represents its <a href="#dfn-url-scope">URL scope</a>, as the arguments.</p>
    </spec-section>

    <spec-section id="service-worker-event-handler">
      <h1>Event handler</h1>

      <p>The following is the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handlers">event handler</a> (and its corresponding <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handler-event-type">event handler event type</a>) that must be supported, as <a href="http://www.whatwg.org/specs/web-apps/current-work/#event-handler-idl-attributes">event handler IDL attributes</a>, by all objects implementing <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> interface. Each <a href="http://www.whatwg.org/specs/web-apps/current-work/#document">Document</a> object must have a separate object for its <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handlers">event handler</a>:</p>

      <table>
        <thead>
          <tr>
            <th><a href="http://www.whatwg.org/specs/web-apps/current-work/#event-handlers">event handler</a></th>
            <th><a href="http://www.whatwg.org/specs/web-apps/current-work/#event-handler-event-type">event handler event type</a></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><dfn id="service-worker-container-onupdatefound-attribute"><code>onupdatefound</code></dfn></td>
            <td><code><a href="#service-worker-container-updatefound-event">updatefound</a></code></td>
          </tr>
        </tbody>
      </table>
    </spec-section>
  </spec-section>

  <spec-section id="navigator-service-worker">
    <h1><code>navigator.serviceWorker</code></h1>

<spec-idl>partial interface <a href="http://goo.gl/I7WAhg">Navigator</a> {
  readonly attribute <a href="#service-worker-container-interface">ServiceWorkerContainer</a> <a href="#navigator-service-worker-attribute">serviceWorker</a>;
};</spec-idl>

    <p>The <dfn id="navigator-service-worker-attribute"><code>serviceWorker</code></dfn> attribute of the <code><a href="http://goo.gl/I7WAhg">Navigator</a></code> interface must return an instance of the <code><a href="#service-worker-container-interface">ServiceWorkerContainer</a></code> interface, which provides access to registration, removal, upgrade, and communication with Service Workers that are (or will become) active for the current document. Communication with these workers is provided via standard <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/web-messaging.html">HTML5 messaging APIs</a>, and <a href="http://www.w3.org/TR/workers/#dom-worker-postmessage">messaging occurs as per usual with Web Workers</a>.</p>
  </spec-section>

  <spec-section id="service-worker-container">
    <h1><code>ServiceWorkerContainer</code></h1>

<spec-idl>[Exposed=Window]
interface <dfn id="service-worker-container-interface" title="ServiceWorkerContainer">ServiceWorkerContainer</dfn> : <a href="http://goo.gl/x4hwQd">EventTarget</a> {
  [<a href="http://heycam.github.io/webidl/#Unforgeable">Unforgeable</a>] readonly attribute <a href="#service-worker-interface">ServiceWorker</a>? <a href="#service-worker-container-controller-attribute">controller</a>;
  readonly attribute <a href="http://goo.gl/3TobQS">Promise</a>&lt;<a href="#service-worker-registration-interface">ServiceWorkerRegistration</a>&gt; <a href="#service-worker-container-ready-attribute">ready</a>;

  <a href="http://goo.gl/3TobQS">Promise</a>&lt;<a href="#service-worker-registration-interface">ServiceWorkerRegistration</a>&gt; <a href="#service-worker-container-register-method">register</a>(<a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a> <var>scriptURL</var>, optional <a href="#registration-option-list-dictionary">RegistrationOptionList</a> <var>options</var>);

  <a href="http://goo.gl/3TobQS">Promise</a>&lt;<a href="#service-worker-registration-interface">ServiceWorkerRegistration</a>&gt; <a href="#service-worker-container-getall-method">getRegistration</a>(optional <a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a> <var>documentURL</var> = "");
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;sequence&lt;<a href="#service-worker-registration-interface">ServiceWorkerRegistration</a>&gt;?&gt; <a href="#service-worker-container-getall-method">getRegistrations</a>();


  // events
  attribute <a href="http://goo.gl/3nnYrx">EventHandler</a> <a href="#service-worker-container-oncontrollerchange-attribute">oncontrollerchange</a>;
  attribute <a href="http://goo.gl/3nnYrx">EventHandler</a> <a href="#service-worker-container-onreloadpage-attribute">onreloadpage</a>;
  attribute <a href="http://goo.gl/3nnYrx">EventHandler</a> <a href="#service-worker-container-onerror-attribute">onerror</a>;
};

dictionary <dfn id="registration-option-list-dictionary" title="RegistrationOptionList">RegistrationOptionList</dfn> {
  <a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a> scope = "/";
};

[Constructor(DOMString <var>type</var>, optional <a href="http://goo.gl/AbWMT8">EventInit</a> <var>eventInitDict</var>)]
interface <dfn id="reload-page-event-interface" title="ReloadPageEvent">ReloadPageEvent</dfn> : <a href="http://goo.gl/UVs0Yt">Event</a> {
  void waitUntil(<a href="http://goo.gl/3TobQS">Promise</a>&lt;any&gt; <var>f</var>);
};</spec-idl>

  <spec-section id="navigator-service-worker-controller">
    <h1><code>controller</code></h1>

    <p><dfn id="service-worker-container-controller-attribute"><code>controller</code></dfn> attribute must return a <code><a href="#service-worker-interface">ServiceWorker</a></code> object representing the <a href="#dfn-active-worker">active worker</a> that currently handles resource requests for the document. <code><a href="#service-worker-container-controller-attribute">navigator.serviceWorker.controller</a></code> returns <code>null</code> if the current document was not <a href="#on-fetch-request-algorithm">created under a Service Worker</a> (See step 13-1 of <a href="#on-fetch-request-algorithm">[[HandleFetch]]</a> algorithm) or the request is a force refresh (shift+refresh). Each <a href="http://www.whatwg.org/specs/web-apps/current-work/#document">Document</a> object must have a separate object for its <code><a href="#service-worker-container-interface">ServiceWorkerContainer</a></code>'s <code><a href="#service-worker-container-controller-attribute">controller</a></code> attribute.</p>
  </spec-section>
  <spec-section id="navigator-service-worker-ready">
    <h1><code>ready</code></h1>

    <p><dfn id="service-worker-container-ready-attribute"><code>ready</code></dfn> attribute must return the result of running these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>
    <spec-algorithm>
    <ol>
      <li>Let <var>promise</var> be a new <a href="http://goo.gl/3TobQS">promise</a>.</li>
      <li>Run the following substeps asynchronously:
        <ol>
          <li>Let <var>registration</var> be null.</li>
          <li>Let <var>documentURL</var> be the result of running the <a href="http://url.spec.whatwg.org/#concept-url-serializer">URL serializer</a> on the document's URL.</li>
          <li>Set <var>registration</var> to the result of running <a href="#scope-match-algorithm">[[MatchScope]]</a> algorithm, or its <a href="#dfn-processing-equivalence">equivalent</a>, with <var>documentURL</var> as its argument.</li>
          <li>If <var>registration</var> is null, then:
            <ol>
              <li>Wait for the document to have a <a href="#scope-match-algorithm">matching</a> <a href="#dfn-registration">registration</a>.</li>
              <li>Set <var>registration</var> to the corresponding <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object.</li>
            </ol>
          </li>
          <li>If <var>registration</var>.<var>active</var> is null, then:
            <ol>
              <li>Wait until the <a href="#dfn-registration">registration</a>, represented by <var>registration</var>, acquires an <a href="#dfn-active-worker">active worker</a> through a new <a href="#dfn-activation-process">activation process</a>.</li>
              <li>Resolve <var>promise</var> with <var>registration</var>.</li>
            </ol>
          </li>
        </ol>
      </li>
      <li>Return <var>promise</var>. Each <a href="http://www.whatwg.org/specs/web-apps/current-work/#document">Document</a> object must have a separate object for the <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object which its <code><a href="#service-worker-container-interface">ServiceWorkerContainer</a></code>'s <code><a href="#service-worker-container-controller-attribute">ready</a></code> attribute resolves with.</li>
    </ol>
    </spec-algorithm>
    <p class="note">The <code><a href="#service-worker-container-ready-attribute">ready</a></code> attribute is designed in a way that the returned <a href="http://goo.gl/3TobQS">promise</a> will never reject. Instead, it waits until the <a href="http://goo.gl/3TobQS">promise</a> resolves with an <a href="#dfn-active-worker">active worker</a>. Hence, the <code><a href="#service-worker-state-attribute">state</a></code> of the acquired <code><a href="#service-worker-interface">ServiceWorker</a></code> object is either "<code>activating</code>" or "<code>activated</code>".</p>
    <p class="fixme">The algorithm for <code><a href="#service-worker-container-ready-attribute">ready</a></code> attribute will be refined.</p>
  </spec-section>

  <spec-section id="navigator-service-worker-register">
    <h1><code>register(<var>scriptURL</var>, <var>options</var>)</code></h1>

    <p>The <code><a href="#service-worker-container-register-method">register(<var>scriptURL</var>, <var>options</var>)</a></code> method creates or updates a <a href="#dfn-registration">registration</a> for some amount of <a href="#dfn-url-scope">URL scope</a>. If successful, a <a href="#dfn-registration">registration</a> ties the provided <var>scriptURL</var> to a <a href="#dfn-url-scope">URL scope</a>, which is subsequently used for <a href="#on-fetch-request-algorithm">navigation matching</a>.</p>

    <p><dfn id="service-worker-container-register-method"><code>register(<var>scriptURL</var>, <var>options</var>)</code></dfn> method must return the result of running these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>
    <spec-algorithm>
    <ol>
      <li>Let <var>p</var> be the result of running the <a href="#register-algorithm">[[Register]]</a> algorithm, or their <a href="#dfn-processing-equivalence">equivalent</a>, passing the associated <var>document</var>, <var>scriptURL</var>, and <var>options</var>.<var>scope</var> as the arguments.</li>
      <li>Return <var>p</var>. Each <a href="http://www.whatwg.org/specs/web-apps/current-work/#document">Document</a> object must have a separate object for the <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object which the result of running its <code><a href="#service-worker-container-interface">ServiceWorkerContainer</a></code>'s <code><a href="#service-worker-container-register-method">register</a></code> method resolves with.</li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="navigator-service-worker-getRegistration">
    <h1><code>getRegistration(<var>documentURL</var>)</code></h1>

    <p><dfn id="service-worker-container-getregistration-method"><code>getRegistration(<var>documentURL</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

    <spec-algorithm>
    <ol>
      <li>Let <var>promise</var> be a new <a href="http://goo.gl/3TobQS">promise</a>.</li>
      <li>Run the following substeps asynchronously:
        <ol>
          <li>Let <var>documentURL</var> be the result of running the <a href="http://url.spec.whatwg.org/#concept-url-parser">URL parser</a> on <var>documentURL</var> with <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#entry-settings-object">entry settings object</a>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/#api-base-url">API base URL</a>.</li>
          <li>Set <var>documentURL</var> to the result of running the <a href="http://url.spec.whatwg.org/#concept-url-serializer">URL serializer</a> on <var>documentURL</var>.</li>
          <li>If the <a href="http://www.whatwg.org/specs/web-apps/current-work/#origin">origin</a> of <var>documentURL</var> does not match the document's <a href="http://www.whatwg.org/specs/web-apps/current-work/#origin">origin</a>, then:
            <ol>
              <li>Reject <var>promise</var> with a "<code><a href="http://dom.spec.whatwg.org/#securityerror">SecurityError</a></code>" exception.</li>
              <li>Abort these steps.</li>
            </ol>
          </li>
          <li>Let <var>registration</var> be the result of running <a href="#scope-match-algorithm">[[MatchScope]]</a> algorithm, or its equivalent, with <var>documentURL</var> as its argument.</li>
          <li>If <var>registration</var> is not null, then:
            <ol>
              <li>Resolve <var>promise</var> with <var>registration</var>.</li>
            </ol>
          </li>
          <li>Else:
            <ol>
              <li>Resolve <var>promise</var> with <code>undefined</code>.</li>
            </ol>
          </li>
        </ol>
      </li>
      <li>Return <var>promise</var>. Each <a href="http://www.whatwg.org/specs/web-apps/current-work/#document">Document</a> object must have a separate object for the <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object which the result of running its <code><a href="#service-worker-container-interface">ServiceWorkerContainer</a></code>'s <code><a href="#service-worker-container-getregistration-method">getRegistration(<var>documentURL</var>)</a></code> method resolves with.</li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="navigator-service-worker-getRegistrations">
    <h1><code>getRegistrations()</code></h1>

    <p><dfn id="service-worker-container-getregistrations-method"><code>getRegistrations()</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>


    <!--p>return a <a href="http://goo.gl/3TobQS">promise</a> that resolves with the array of the <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> objects.</p-->

    <spec-algorithm>
    <ol>
      <li>Let <var>promise</var> be a new <a href="http://goo.gl/3TobQS">promise</a>.</li>
      <li>Run the following substeps asynchronously:
        <ol>
          <li>Let <var>array</var> be an empty array.</li>
          <li>Let <var>origin</var> be the <a href="http://tools.ietf.org/html/rfc6454#section-6.1">unicode serialization</a> of the document's <a href="http://www.whatwg.org/specs/web-apps/current-work/#origin">origin</a>.</li>
          <li>For each Record {[[key]], [[value]]} <var>entry</var> of its <a href="#service-worker-registration-map-internal-interface">[[ScopeToRegistrationMap]]</a>:
            <ol>
              <li>If the <a href="http://www.whatwg.org/specs/web-apps/current-work/#origin">origin</a> of <var>entry</var>.[[key]] matches <var>origin</var>, then:
                <ol>
                  <li>Add <var>entry</var>.[[value]] to the <var>array</var>.</li>
                </ol>
              </li>
            </ol>
          </li>
          <li>Resolve <var>promise</var> with <var>array</var>.</li>
        </ol>
      </li>
      <li>Return <var>promise</var>. Each <a href="http://www.whatwg.org/specs/web-apps/current-work/#document">Document</a> object must have a separate object for the array of <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> objects which the result of running its <code><a href="#service-worker-container-interface">ServiceWorkerContainer</a></code>'s <code><a href="#service-worker-container-getregistrations-method">getRegistrations()</a></code> method resolves with.</li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="service-worker-container-event-handlers">
      <h1>Event handlers</h1>

      <p>The following are the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handlers">event handlers</a> (and its corresponding <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handler-event-type">event handler event types</a>) that must be supported, as <a href="http://www.whatwg.org/specs/web-apps/current-work/#event-handler-idl-attributes">event handler IDL attributes</a>, by all objects implementing the <a href="#service-worker-container-interface">ServiceWorkerContainer</a> interface:</p>

      <table>
        <thead>
          <tr>
            <th><a href="http://www.whatwg.org/specs/web-apps/current-work/#event-handlers">event handler</a></th>
            <th><a href="http://www.whatwg.org/specs/web-apps/current-work/#event-handler-event-type">event handler event type</a></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><dfn id="service-worker-container-oncontrollerchange-attribute"><code>oncontrollerchange</code></dfn></td>
            <td><code><a href="#service-worker-container-controllerchange-event">controllerchange</a></code></td>
          </tr>
          <tr>
            <td><dfn id="service-worker-container-onreloadpage-attribute"><code>onreloadpage</code></dfn></td>
            <td><code><a href="#service-worker-container-reloadpage-event">reloadpage</a></code></td>
          </tr>
          <tr>
            <td><dfn id="service-worker-container-onerror-attribute"><code>onerror</code></dfn></td>
            <td><code><a href="#service-worker-container-error-event">error</a></code></td>
          </tr>
        </tbody>
      </table>
    </spec-section>
  </spec-section>

  <spec-section id="document-context-events">
    <h1>Events</h1>

    <p>The following events are dispatched on <code><a href="#service-worker-interface">ServiceWorker</a></code> object:</p>

    <table>
      <thead>
        <tr>
          <th>Event name</th>
          <th>Interface</th>
          <th>Dispatched when&mldr;</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><dfn id="service-worker-statechange-event"><code>statechange</code></dfn></td>
          <td><code><a href="http://dom.spec.whatwg.org/#event">Event</a></code></td>
          <td>The <code><a href="#service-worker-state-attribute">state</a></code> attribute of the <code><a href="#service-worker-interface">ServiceWorker</a></code> object is changed.</td>
        </tr>
      </tbody>
    </table>

    <p>The following events are dispatched on <code><a href="#service-worker-container-interface">ServiceWorkerContainer</a></code> object:</p>

    <table>
      <thead>
        <tr>
          <th>Event name</th>
          <th>Interface</th>
          <th>Dispatched when&mldr;</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><dfn id="service-worker-container-updatefound-event"><code>updatefound</code></dfn></td>
          <td><code><a href="http://dom.spec.whatwg.org/#event">Event</a></code></td>
          <td>A <a href="#dfn-registration">registration</a> enters the <a href="#dfn-installation-process">installation process</a> such that <code><a href="#service-worker-registration-installing-attribute">serviceWorkerRegistration.installing</a></code> becomes the new <a href="#dfn-installing-worker">installing worker</a> (See step 6 of the <a href="#installation-algorithm">[[Install]]</a> algorithm).</td>
        </tr>
        <tr>
          <td><dfn id="service-worker-container-controllerchange-event"><code>controllerchange</code></dfn></td>
          <td><code><a href="http://dom.spec.whatwg.org/#event">Event</a></code></td>
          <td>The document's associated <a href="#dfn-registration">registration</a> enters the <a href="#dfn-activation-process">activation process</a>. (See step 8 of the <a href="#activation-algorithm">[[Activate]]</a> algorithm. When the <a href="#dfn-activation-process">activation process</a> is triggered by <a href="#install-event-replace-method">replace</a>() method call within the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handlers">event handler</a> of the <a href="#service-worker-global-scope-install-event">install event</a>, <code><a href="#service-worker-container-controller-attribute">navigator.serviceWorker.controller</a></code> immediately reflects the <a href="#dfn-active-worker">active worker</a> as the Service Worker that <a href="#dfn-document-control">controls</a> the document.)</td>
        </tr>
        <tr>
          <td><dfn id="service-worker-container-reloadpage-event"><code>reloadpage</code></dfn></td>
          <td><code><a href="#reload-page-event-interface">ReloadPageEvent</a></code></td>
          <td>The page reload is triggered by the <code><a href="#service-worker-clients-reloadall-method">self.clients.reloadAll()</a></code> method call from the <a href="#dfn-active-worker">active worker</a>, represented by its associated <code><a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> object, for the document.</td>
        </tr>
        <tr>
          <td><dfn id="service-worker-container-error-event"><code>error</code></dfn></td>
          <td><code><a href="http://goo.gl/FKuWgu">ErrorEvent</a></code></td>
          <td>Any error occurred from the associated Service Workers.</td>
        </tr>
      </tbody>
    </table>
  </spec-section>
</spec-clause>

<spec-clause id="execution-context">
  <h1>Execution Context</h1>

  <P>Example: Serving Cached Resources</P>

<spec-code class="prettyprint">// caching.js
this.addEventListener("install", function(e) {
  var shellResources = new Cache();
  e.waitUntil(
    // Create a cache of resources.
    caches.create("shell-v1").then(function(cache) {
      // Begins the process of fetching them.
      // The coast is only clear when all the resources are ready.
      return cache.addAll([
        "/app.html",
        "/assets/v1/base.css",
        "/assets/v1/app.js",
        "/assets/v1/logo.png",
        "/assets/v1/intro_video.webm"
      ])
    })
  );
});

this.addEventListener("fetch", function(e) {
  // No "fetch" events are dispatched to the ServiceWorker until it
  // successfully installs.

  // All operations on caches are async, including matching URLs, so we use
  // promises heavily. e.respondWith() even takes promises to enable this:
  e.respondWith(
    caches.match(e.request).catch(function() {
      return e.default();
    }).catch(function() {
      return caches.match("/fallback.html");
    })
  );
});</spec-code>

  <spec-section id="service-worker-global-scope">
    <h1><code>ServiceWorkerGlobalScope</code></h1>

<spec-idl>[<a href="http://heycam.github.io/webidl/#Global">Global</a>=(Worker,ServiceWorker), Exposed=ServiceWorker]
interface <dfn id="service-worker-global-scope-interface" title="ServiceWorkerGlobalScope">ServiceWorkerGlobalScope</dfn> : <a href="http://goo.gl/xBhqNU">WorkerGlobalScope</a> {
  readonly attribute <a href="#cache-interface">Cache</a> <a href="#service-worker-global-scope-script-cache-attribute">scriptCache</a>;
  readonly attribute <a href="#cache-storage-interface">CacheStorage</a> <a href="#service-worker-global-scope-caches-attribute">caches</a>;

  // A container for a list of window objects, identifiable by ID, that
  // correspond to windows (or workers) that are "controlled" by this SW
  readonly attribute <a href="#service-worker-clients-interface">ServiceWorkerClients</a> <a href="#service-worker-global-scope-clients-attribute">clients</a>;
  [<a href="http://heycam.github.io/webidl/#Unforgeable">Unforgeable</a>] readonly attribute <a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a> <a href="#service-worker-global-scope-caches-attribute">scope</a>;

  // <a href="#service-worker-global-scope-fetch">fetch</a>(<var>input</var>, <var>init</var>) method is defined in <a href="http://fetch.spec.whatwg.org/">Fetch</a>
  // Promise&lt;Response&gt; fetch(RequestInfo input, optional RequestInit init);

  void <a href="#service-worker-global-scope-update-method">update</a>();
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;boolean&gt; <a href="#service-worker-global-scope-unregister-method">unregister</a>();

  attribute <a href="http://goo.gl/3nnYrx">EventHandler</a> <a href="#service-worker-global-scope-oninstall-attribute">oninstall</a>;
  attribute <a href="http://goo.gl/3nnYrx">EventHandler</a> <a href="#service-worker-global-scope-onactivate-attribute">onactivate</a>;
  attribute <a href="http://goo.gl/3nnYrx">EventHandler</a> <a href="#service-worker-global-scope-onfetch-attribute">onfetch</a>;
  attribute <a href="http://goo.gl/3nnYrx">EventHandler</a> <a href="#service-worker-global-scope-onbeforeevicted-attribute">onbeforeevicted</a>;
  attribute <a href="http://goo.gl/3nnYrx">EventHandler</a> <a href="#service-worker-global-scope-onevicted-attribute">onevicted</a>;

  // The event.source of these MessageEvents are instances of ServiceWorkerClient
  attribute <a href="http://goo.gl/3nnYrx">EventHandler</a> <a href="#service-worker-global-scope-onmessage-attribute">onmessage</a>;

  // close() method inherited from WorkerGlobalScope <a href="#service-worker-global-scope-close-method">should not be accessible</a>.
};
</spec-idl>

    <p>The <code><a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> interface represents the global execution context of a <a href="#dfn-service-worker">Service Worker</a>. <code><a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> object provides generic, event-driven, time-limited script execution contexts that run at an origin. Once successfully <a href="#navigator-service-worker-register">registered</a>, a Service Worker is started, kept alive and killed by their relationship to events, not documents. Any type of synchronous requests MUST NOT be initiated inside of a Service Worker.</p>

    <p id="service-worker-global-scope-close-method" class="note">The <code><a href="http://www.w3.org/TR/workers/#dom-workerglobalscope-close">close()</a></code> method inherited from <code><a href="http://www.w3.org/TR/workers/#workerglobalscope">WorkerGlobalScope</a></code>, when called on the <a href="http://dom.spec.whatwg.org/#context-object">context object</a>, should throw an "<code><a href="http://dom.spec.whatwg.org/#invalidaccesserror">InvalidAccessError</a></code>" exception.</p>

    <spec-section id="service-worker-global-scope-script-cache">
      <h1><code>scriptCache</code></h1>

      <p><dfn id="service-worker-global-scope-script-cache-attribute"><code>scriptCache</code></dfn> must return a <code><a href="#cache-interface">Cache</a></code> object that represents the storage for scripts that are cached as part of the Service Worker installation.</p>
    </spec-section>
    <spec-section id="service-worker-global-scope-caches">
      <h1><code>caches</code></h1>

      <p><dfn id="service-worker-global-scope-caches-attribute"><code>caches</code></dfn> attribute must return the <code><a href="#cache-storage-interface">CacheStorage</a></code> object that is the global asynchronous map object for the <code><a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> execution context containing the <code><a href="#cache-interface">Cache</a></code> objects keyed by the name of the <code><a href="#cache-interface">Cache</a></code> objects. <code><a href="#cache-interface">Cache</a></code> objects are always enumerable via <code><a href="#service-worker-global-scope-caches-attribute">self.caches</a></code> in insertion order (per <a href="http://goo.gl/gNnDPO">ECMAScript 6 Map objects</a>.)</p>
    </spec-section>
    <spec-section id="service-worker-global-scope-clients">
      <h1><code>clients</code></h1>

      <p><dfn id="service-worker-global-scope-clients-attribute"><code>clients</code></dfn> attribute must return the <code><a href="#service-worker-clients-interface">ServiceWorkerClients</a></code> object containing a list of client objects, identifiable by ID, that correspond to windows or workers that are <a href="#dfn-document-control">controlled</a> by this Service Worker.</p>
    </spec-section>
    <spec-section id="service-worker-global-scope-scope">
      <h1><code>scope</code></h1>

      <p>The <code>scope</code> attribute of a <a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a> object reflects the <a href="#dfn-url-scope">URL scope</a> of the associated <a href="#dfn-registration">registration</a>. The <dfn id="service-worker-global-scope-scope-attribute"><code>scope</code></dfn> attribute must return the <a href="http://url.spec.whatwg.org/#concept-url-serializer">serialization</a> of the URL representing the <a href="#dfn-url-scope">URL scope</a> of the associated <a href="#dfn-registration">registration</a>.</p>
    </spec-section>
    <spec-section id="service-worker-global-scope-fetch">
      <h1><code>fetch(<var>input</var>, <var>init</var>)</code></h1>

      <p><dfn id="service-worker-global-scope-fetch-method"><code>fetch(<var>input</var>, <var>init</var>)</code></dfn> method is defined on the <a href="http://fetch.spec.whatwg.org/#globalfetch">GlobalFetch</a> interface implemented by the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/workers.html#workerglobalscope">WorkerGlobalScope</a> interface that the <a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a> inherits from. When a script invokes the <code><a href="http://fetch.spec.whatwg.org/#dom-global-fetch">fetch(<var>input</var>, <var>init</var>)</a></code> method on a <a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a> object, the UA must run the <a href="http://fetch.spec.whatwg.org/#dom-global-fetch">steps</a> defined in the <code><a href="http://fetch.spec.whatwg.org/#dom-global-fetch">fetch(<var>input</var>, <var>init</var>)</a></code> method.</p>
    </spec-section>
    <spec-section id="service-worker-global-scope-update">
      <h1><code>update()</code></h1>

      <p><code>update()</code> pings the server for an updated version of this script without consulting caches.</p>
      <p><dfn id="service-worker-global-scope-update-method"><code>update()</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>
      <spec-algorithm>
      <ol>
        <li>Let <var>workerGlobalScope</var> be the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#script-settings-object">script settings object</a>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#global-object">global object</a>.</li>
        <li>Let <var>scope</var> be an <a href="http://url.spec.whatwg.org/#concept-absolute-url">absolute URL</a>, <a href="http://url.spec.whatwg.org/#concept-host-serializer">serialized</a>, representing the <a href="#dfn-url-scope">URL scope</a> of the Service Worker associated with <var>workerGlobalScope</var>.</li>
        <li>Let <var>registration</var> be the result of running <a href="#get-register-algorithm">[[GetRegistration]]</a> algorithm passing <var>scope</var> as the argument.</li>
        <li>Invoke <a href="#soft-update-algorithm">[[SoftUpdate]]</a> algorithm, or its <a href="#dfn-processing-equivalence">equivalent</a>, passing <var>registration</var> as the argument.</li>
      </ol>
      </spec-algorithm>

      <p class="note">This is conceptually the same operation that UA does maximum once per every 24 hours.</p>
    </spec-section>
    <spec-section id="service-worker-global-scope-unregister">
      <h1><code>unregister()</code></h1>

      <p>The <code><a href="#service-worker-global-scope-unregister-method">unregister()</a></code> method unregisters the <a href="#dfn-registration">registration</a> for its <a href="#dfn-url-scope">URL scope</a>. It is important to note that this <a href="#dfn-registration">registration</a> is effective until all the documents (including itself) using this <a href="#dfn-registration">registration</a> unload. That is, <code><a href="#service-worker-global-scope-unregister-method">unregister()</a></code> method only affects subsequent <a href="http://www.whatwg.org/specs/web-apps/current-work/#navigate">navigations</a>.</p>

      <p><dfn id="service-worker-global-scope-unregister-method"><code>unregister()</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

      <spec-algorithm>
      <ol>
        <li>Let <var>workerGlobalScope</var> be the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#script-settings-object">script settings object</a>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#global-object">global object</a>.</li>
        <li>Let <var>scope</var> be a string representing the <a href="#dfn-path-prefix">path prefix</a> of <a href="#dfn-url-scope">URL scope</a> of the Service Worker associated with <var>workerGlobalScope</var>.</li>
        <li>Return the result of running <a href="#unregister-algorithm">[[Unregister]]</a> algorithm, or its <a href="#dfn-processing-equivalence">equivalent</a>, passing the associated document <var>document</var> and <var>scope</var> as the argument.</li>
      </ol>
      </spec-algorithm>
    </spec-section>

    <spec-section id="service-worker-global-scope-event-handlers">
      <h1>Event handlers</h1>

      <p>The following are the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handlers">event handlers</a> (and its corresponding <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handler-event-type">event handler event types</a>) that must be supported, as <a href="http://www.whatwg.org/specs/web-apps/current-work/#event-handler-idl-attributes">event handler IDL attributes</a>, by all objects implementing the <a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a> interface:</p>

      <table>
        <thead>
          <tr>
            <th><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handlers">event handler</a></th>
            <th><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handler-event-type">event handler event type</a></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><dfn id="service-worker-global-scope-oninstall-attribute"><code>oninstall</code></dfn></td>
            <td><code><a href="#service-worker-global-scope-install-event">install</a></code></td>
          </tr>
          <tr>
            <td><dfn id="service-worker-global-scope-onactivate-attribute"><code>onactivate</code></dfn></td>
            <td><code><a href="#service-worker-global-scope-activate-event">activate</a></code></td>
          </tr>
          <tr>
            <td><dfn id="service-worker-global-scope-onfetch-attribute"><code>onfetch</code></dfn></td>
            <td><code><a href="#service-worker-global-scope-fetch-event">fetch</a></code></td>
          </tr>
          <tr>
            <td><dfn id="service-worker-global-scope-onbeforeevicted-attribute"><code>onbeforeevicted</code></dfn></td>
            <td><code><a href="#service-worker-global-scope-beforeevicted-event">beforeevicted</a></code></td>
          </tr>
          <tr>
            <td><dfn id="service-worker-global-scope-onevicted-attribute"><code>onevicted</code></dfn></td>
            <td><code><a href="#service-worker-global-scope-evicted-event">evicted</a></code></td>
          </tr>
          <tr>
            <td><dfn id="service-worker-global-scope-onmessage-attribute"><code>onmessage</code></dfn></td>
            <td><code><a href="http://www.whatwg.org/specs/web-apps/current-work/#event-message">message</a></code></td>
          </tr>
        </tbody>
      </table>

      <p class="note">For <a href="#service-worker-global-scope-onmessage-attribute">onmessage <a href="http://goo.gl/rBfiz0">event handler</a>,<code><a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> objects act as if they had an implicit <code><a href="http://goo.gl/tHBrI6">MessagePort</a></code> associated with them. This port is part of a channel that is set up when the worker is created, but it is not exposed. This object must never be garbage collected before the <code><a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> object. All messages received by that port must immediately be retargeted at the <code><a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> object. That is, an event named <code>message</code> using the <code><a href="http://goo.gl/S5e0b6">MessageEvent</a></code> interface is dispatched on <a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a> object. The <code><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/comms.html#dom-messageevent-source">event.source</a></code> of these <code><a href="http://goo.gl/S5e0b6">MessageEvent</a></code>s are instances of <code><a href="#service-worker-client-interface">ServiceWorkerClient</a></code>.</p>
    </spec-section>
  </spec-section>
  <spec-section id="service-worker-client">
    <h1><code>ServiceWorkerClient</code></h1>

<spec-idl>[Exposed=ServiceWorker]
interface <dfn id="service-worker-client-interface" title="ServiceWorkerClient">ServiceWorkerClient</dfn> {
  readonly attribute unsigned long <a href="#service-worker-client-id-attribute">id</a>;
  void <a href="http://goo.gl/Kze9t3">postMessage</a>(any <var>message</var>, optional sequence&lt;<a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#transferable">Transferable</a>&gt; <var>transfer</var>);
};
</spec-idl>

    <p>The <code><a href="#service-worker-client-interface">ServiceWorkerClient</a></code> interface represents the window or the worker (defined as client) that is <a href="#dfn-document-control">controlled</a> by the <a href="#dfn-service-worker">Service Worker</a>.</p>

    <p>The <dfn id="service-worker-client-id-attribute"><code>id</code></dfn> attribute of a <code><a href="#service-worker-client-interface">ServiceWorkerClient</a></code> identifies the specific client object from the list of client objects serviced by the Service Worker. The <code><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/web-messaging.html#dom-window-postmessage">postMessage(<var>message</var>, <var>transfer</var>)</a></code> method of a <code><a href="#service-worker-client-interface">ServiceWorkerClient</a></code>, when called, causes a <code><a href="http://goo.gl/4SLWiH">MessageEvent</a></code> to be dispatched at the client object.</p>

  </spec-section>
  <spec-section id="service-worker-clients">
    <h1><code>ServiceWorkerClients</code></h1>

<spec-idl>[Exposed=ServiceWorker]
interface <dfn id="service-worker-clients-interface" title="ServiceWorkerClients">ServiceWorkerClients</dfn> {
  // A list of client objects, identifiable by ID, that correspond to windows
  // (or workers) that are "controlled" by this SW
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;sequence&lt;<a href="#service-worker-client-interface">ServiceWorkerClient</a>&gt;?&gt; <a href="#service-worker-clients-getserviced-method">getServiced</a>();
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;any&gt; <a href="#service-worker-clients-reloadall-method">reloadAll</a>();
};
</spec-idl>

    <p>The <code><a href="#service-worker-clients-interface">ServiceWorkerClients</a></code> interface represents a container for a list of <code><a href="#service-worker-client-interface">ServiceWorkerClient</a></code> objects.</p>
    <spec-section id="get-serviced-method">
      <h1><code>getServiced()</code></h1>
      <p>The <dfn id="service-worker-clients-getserviced-method"><code>getServiced()</code></dfn> method must return a <a href="http://goo.gl/3TobQS">promise</a> that will resolve with a list of <code><a href="#service-worker-client-interface">ServiceWorkerClient</a></code> objects that are <a href="#dfn-document-control">controlled</a> by this Service Worker.</p>
    </spec-section>
    <spec-section id="reloadall-method">
      <h1><code>reloadAll()</code></h1>

      <p><dfn id="service-worker-clients-reloadall-method"><code>reloadAll()</code></dfn> method provides a mechanism for the worker to request synchronized re-fetch of all documents whose URLs match the registration's <a href="#dfn-url-scope">URL scope</a>. An event named <code><a href="#service-worker-container-reloadpage-event">reloadpage</a></code> is dispatched on the <code><a href="#navigator-service-worker-attribute">navigator.serviceWorker</a></code> object of each document. The in-document handlers may allow the event to continue, request an extension (via <code><a href="#install-phase-event-waituntil-method">event.waitUntil(<var>f</var>)</a></code>), or cancel the collective reload by calling <code><a href="http://goo.gl/2zH6ie">event.preventDefault()</a></code>.</p>

      <p class="fixme">The algorithm will be updated in a more formal language.</p>

      <!-- If the group-reload is canceled, // FIXME(slightlyoff) -->
    </spec-section>
  </spec-section>

  <spec-section id="request-objects">
    <h1><code>Request</code> Objects</h1>
    <p><code><a href="http://fetch.spec.whatwg.org/#request">Request</a></code> objects model HTTP requests. The <code><a href="http://fetch.spec.whatwg.org/#request">Request</a></code> interface is defined in <a href="http://fetch.spec.whatwg.org/">Fetch</a>. A <a href="http://fetch.spec.whatwg.org/#concept-request">request</a> is an input to <a href="http://fetch.spec.whatwg.org/#concept-fetch">fetch</a>, and accordingly a <code><a href="http://fetch.spec.whatwg.org/#request">Request</a></code> object is used as the first argument for the <code><a href="http://fetch.spec.whatwg.org/#dom-global-fetch">fetch(<var>input</var>, <var>init</var>)</a></code> method. A <code><a href="http://fetch.spec.whatwg.org/#request">Request</a></code> object is a key for the <code><a href="#cache-interface">Cache</a></code> object.</p>

    <p class="fixme">The section will be updated.</p>
  </spec-section>

  <spec-section id="response-objects">
    <h1><code>Response</code> Objects</h1>

    <p><code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code> objects model HTTP responses. The <a href="http://fetch.spec.whatwg.org/#response">Response</a> interface is defined in <a href="http://fetch.spec.whatwg.org/">Fetch</a>. A <a href="http://fetch.spec.whatwg.org/#concept-response">response</a> is an output as a result of performing a <a href="http://fetch.spec.whatwg.org/#concept-fetch">fetch</a>, and accordingly a <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code> object is the value the returned <a href="http://goo.gl/3TobQS">promise</a> from <code><a href="http://fetch.spec.whatwg.org/#dom-global-fetch">fetch(<var>input</var>, <var>init</var>)</a></code> method resolves with. A <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code> object is a value for the <code><a href="#cache-interface">Cache</a></code> object.</p>

    <p class="fixme">The section will be updated.</p>
  </spec-section>

  <spec-section id="cache-objects">
    <h1>Caches</h1>

    <p>To allow authors to fully manage their content caches for offline use, the <code><a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> execution context provides the caching methods largely conforming to <a href="http://goo.gl/gNnDPO">ECMAScript 6 Map objects</a> with additional convenience methods. A domain can have multiple, named <code><a href="#cache-interface">Cache</a></code> objects, whose contents are entirely under the control of scripts. Caches are not shared across domains, and they are completely isolated from the browser's HTTP cache.</p>

    <spec-section id="cache-lifetimes">
      <h1>Understanding Cache Lifetimes</h1>

      <p>The <code><a href="#cache-interface">Cache</a></code> instances are not part of the browser's HTTP cache. The <code><a href="#cache-interface">Cache</a></code> objects are exactly what authors have to manage themselves. The <code><a href="#cache-interface">Cache</a></code> objects do not get updated unless authors explicitly request them to be. The <code><a href="#cache-interface">Cache</a></code> objects do not expire unless authors delete the entries. The <code><a href="#cache-interface">Cache</a></code> objects do not disappear just because the Service Worker script is updated. That is, caches are not updated automatically. Updates must be manually managed. This implies that authors should version their caches by name and make sure to use the caches only from the version of the ServiceWorker that can safely operate on.</p>
    </spec-section>

    <spec-section id="cache">
      <h1><code>Cache</code></h1>
<spec-idl>
[Exposed=ServiceWorker]
interface <dfn id="cache-interface" title="Cache">Cache</dfn> {
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;<a href="http://fetch.spec.whatwg.org/#response">Response</a>&gt; match((<a href="http://fetch.spec.whatwg.org/#request">Request</a> or <a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a>) <var>request</var>, optional <a href="#query-params-dictionary">QueryParams</a> <var>params</var>);
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;sequence&lt;<a href="http://fetch.spec.whatwg.org/#response">Response</a>&gt;&gt; matchAll(optional (<a href="http://fetch.spec.whatwg.org/#request">Request</a> or <a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a>) <var>request</var>, optional <a href="#query-params-dictionary">QueryParams</a> <var>params</var>);
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;<a href="http://fetch.spec.whatwg.org/#response">Response</a>&gt; add((<a href="http://fetch.spec.whatwg.org/#request">Request</a> or <a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a>) <var>request</var>);
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;sequence&lt;<a href="http://fetch.spec.whatwg.org/#response">Response</a>&gt;&gt; addAll(sequence&lt;(<a href="http://fetch.spec.whatwg.org/#request">Request</a> or <a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a>)&gt; <var>requests</var>);
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;<a href="http://fetch.spec.whatwg.org/#response">Response</a>&gt; put((<a href="http://fetch.spec.whatwg.org/#request">Request</a> or <a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a>) <var>request</var>, <a href="http://fetch.spec.whatwg.org/#response">Response</a> <var>response</var>);
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;boolean&gt; delete((<a href="http://fetch.spec.whatwg.org/#request">Request</a> or <a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a>) <var>request</var>, optional <a href="#query-params-dictionary">QueryParams</a> <var>params</var>);
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;sequence&lt;<a href="http://fetch.spec.whatwg.org/#request">Request</a>&gt;&gt; keys(optional (<a href="http://fetch.spec.whatwg.org/#request">Request</a> or <a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a>) <var>request</var>, optional <a href="#query-params-dictionary">QueryParams</a> <var>params</var>);
};

dictionary <dfn id="query-params-dictionary" title="QueryParams">QueryParams</dfn> {
  boolean ignoreSearch;
  boolean ignoreMethod;
  boolean ignoreVary;
  boolean prefixMatch;
  DOMString cacheName;
};

dictionary <dfn id="cache-batch-operation-dictionary" title="CacheBatchOperation">CacheBatchOperation</dfn> {
  DOMString type;
  Request request;
  Response response;
  QueryParams matchParams;
};
</spec-idl>
      <p>The <code><a href="#cache-interface">Cache</a></code> interface represents the storage for the pairs of a <a href="http://fetch.spec.whatwg.org/#request">Request</a> object and a <a href="http://fetch.spec.whatwg.org/#request">Response</a> object that are cached as part of the Service Worker installation. A <code><a href="#cache-interface">Cache</a></code> object has a <a href="#request-to-response-map-internal-interface">[[RequestToResponseMap]]</a> object.</p>

      <p>Each <code><a href="#cache-interface">Cache</a></code> object is associated with a <a href="#request-to-response-map-internal-interface">[[RequestToResponseMap]]</a>. Multiple separate objects implementing the <code><a href="#cache-interface">Cache</a></code> interface across <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#worker-environment">service worker environments</a> can all be associated with the same <a href="#request-to-response-map-internal-interface">[[RequestToResponseMap]]</a> simultaneously.</p>

      <p class="fixme"><strong>Caveat: </strong>Implementors should note that the interface defined in this section is subject to change according to the <a href="https://github.com/slightlyoff/ServiceWorker/issues">ongoing discussion</a>. </p>

      <spec-section id="cache-match">
        <h1><code>match(<var>request</var>, <var>params</var>)</code></h1>

        <p><dfn id="cache-match-method"><code>match(<var>request</var>, <var>params</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

        <spec-algorithm>
        <ol>
          <li>Let <var>promise</var> be a new <a href="http://goo.gl/3TobQS">promise</a>.</li>
          <li>Run these steps asynchronously:
            <ol>
              <li>Let <var>p</var> be the result of running the algorithm specified in <code><a href="#cache-matchall-method">matchAll(<var>request</var>, <var>params</var>)</a></code> method with <var>request</var> and <var>params</var> as the arguments.</li>
              <li>Wait until <var>p</var> settles.</li>
              <li>If <var>p</var> rejects with an exception, then:
                <ol>
                  <li>Reject <var>promise</var> with that exception.</li>
                </ol>
              </li>
              <li>Else if <var>p</var> resolves with an array, <var>responseArray</var>, then:
                <ol>
                  <li>If <var>responseArray</var> is an empty array, then:
                    <ol>
                      <li>Reject <var>promise</var> with an "<code><a href="http://dom.spec.whatwg.org/#notfounderror">NotFoundError</a></code>" exception.</li>
                    </ol>
                  </li>
                  <li>Else:
                    <ol>
                      <li>Resolve <var>promise</var> with the first element of <var>responseArray</var>.</li>
                    </ol>
                  </li>
                </ol>
              </li>
            </ol>
          </li>
          <li>Return <var>promise</var>.</li>
        </ol>
        </spec-algorithm>
      </spec-section>

      <spec-section id="cache-matchall">
        <h1><code>matchAll(<var>request</var>, <var>params</var>)</code></h1>

        <p><dfn id="cache-matchall-method"><code>matchAll(<var>request</var>, <var>params</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

        <spec-algorithm>
        <ol>
          <li>Let <var>promise</var> be a new <a href="http://goo.gl/3TobQS">promise</a>.</li>
          <li>Run these steps asynchronously:
            <ol>
              <li>Let <var>responseArray</var> be an empty array.</li>
              <li>If the optional argument <var>request</var> is omitted, then:
                <ol>
                  <li>For each Record {[[key]], [[value]]} <var>entry</var> of its <a href="#request-to-response-map-internal-interface">[[RequestToResponseMap]]</a>:
                    <ol>
                      <li>Add <var>entry</var>.[[value]] to <var>responseArray</var>.</li>
                    </ol>
                  </li>
                  <li>Resolve <var>promise</var> with <var>responseArray</var>.</li>
                  <li>Abort these steps.</li>
                </ol>
              </li>
              <li>Else:
                <ol>
                  <li>Let <var>entries</var> be the result of running <a href="#query-cache-algorithm">[[QueryCache]]</a> algorithm passing <var>request</var> and <var>params</var> as the arguments.</li>
                  <li>For each <var>entry</var> of <var>entries</var>:
                    <ol>
                      <li>Add <var>entry</var>[1] to <var>responseArray</var>.</li>
                    </ol>
                  </li>
                  <li>Resolve <var>promise</var> with <var>responseArray</var>.</li>
                </ol>
              </li>
            </ol>
          </li>
          <li>Return <var>promise</var>.</li>
        </ol>
        </spec-algorithm>
      </spec-section>

      <spec-section id="cache-add">
        <h1><code>add(<var>request</var>)</code></h1>

        <p><dfn id="cache-add-method"><code>add(<var>request</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

        <spec-algorithm>
        <ol>
          <li>Let <var>requests</var> be an array containing only <var>request</var>.</li>
          <li>Set <var>responseArrayPromise</var> to the result of running the algorithm specified in <code><a href="#cache-addAll-method">addAll(<var>requests</var>)</a></code> passing <var>requests</var> as the argument.</li>
          <li>Let <var>p</var> be <a href="https://github.com/domenic/promises-unwrapping/blob/master/docs/writing-specifications-with-promises.md#manipulating-promises">transforming <var>responseArrayPromise</var> with <var>onFulfilled</var></a>.</li>
          <li><a href="https://github.com/w3ctag/promises-guide#reacting-to-promises">Upon fulfillment of <var>p</var> with value <var>responseArray</var></a>, perform the following substeps, <var>onFulfilled</var>, asynchronously:
            <ol>
              <li>Resolve <var>p</var> with <var>responseArray</var>[0].</li>
            </ol>
          </li>
          <li>Return <var>p</var>.</li>
        </ol>
        </spec-algorithm>
      </spec-section>

      <spec-section id="cache-addAll">
        <h1><code>addAll(<var>requests</var>)</code></h1>

        <p><dfn id="cache-addAll-method"><code>addAll(<var>requests</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

        <spec-algorithm>
        <ol>
          <li>Let <var>responsePromiseArray</var> be an empty array.</li>
          <li>For each <var>request</var> in <var>requests</var>:
            <ol>
              <li>Run the algorithm specified in <code><a href="http://fetch.spec.whatwg.org/#dom-global-fetch">fetch(<var>input</var>, <var>init</var>)</a></code> with <var>request</var> and add the returned value to <var>responsePromiseArray</var>.</li>
            </ol>
          </li>
          <li>Let <var>p</var> be <a href="https://github.com/domenic/promises-unwrapping/blob/master/docs/writing-specifications-with-promises.md#aggregating-promises">waiting for all of <var>responsePromiseArray</var></a>.</li>
          <li>Let <var>q</var> be <a href="https://github.com/domenic/promises-unwrapping/blob/master/docs/writing-specifications-with-promises.md#manipulating-promises">transforming <var>p</var> with <var>onFulfilled</var> and <var>onRejected</var></a>.</li>
          <li><a href="https://github.com/w3ctag/promises-guide#reacting-to-promises">Upon fulfillment of <var>p</var> with value <var>responseArray</var></a>, perform the following substeps, <var>onFulfilled</var>, asynchronously:
            <ol>
              <li>Let <var>operations</var> be an empty array.</li>
              <li>For each <var>response</var> in <var>responseArray</var> with the index <var>index</var>:
                <ol>
                  <li>Let <var>o</var> be an empty object representing a <code><a href="#cache-batch-operation-dictionary">CacheBatchOperation</a></code> dictionary.</li>
                  <li>Set the <var>type</var> dictionary member of <var>o</var> to "put".</li>
                  <li>Set the <var>request</var> dictionary member of <var>o</var> to <var>requests</var>[<var>index</var>].</li>
                  <li>Set the <var>response</var> dictionary member of <var>o</var> to <var>response</var>.</li>
                  <li>Add <var>o</var> to <var>operations</var>.</li>
                </ol>
              </li>
              <li>Set <var>resultPromiseArray</var> to the result of running <a href="#batch-cache-operations-algorithm">[[BatchCacheOperations]]</a> algorithm passing <var>operations</var> as the argument.</li>
              <li>Resolve <var>q</var> with <var>resultPromiseArray</var>.</li>
            </ol>
          </li>
          <li>Upon rejection of <var>p</var> with reason <var>r</var>, perform the following substeps, <var>onRejected</var>, asynchronously:
            <ol>
              <li>Reject <var>q</var> with <var>r</var>.</li>
            </ol>
          </li>
          <li>Return <var>q</var>.</li>
        </ol>
        </spec-algorithm>
      </spec-section>

      <spec-section id="cache-put">
        <h1><code>put(<var>request</var>, <var>response</var>)</code></h1>

        <p><dfn id="cache-put-method"><code>put(<var>request</var>, <var>response</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

        <spec-algorithm>
        <ol>
          <li>Let <var>operations</var> be an empty array.</li>
          <li>Let <var>o</var> be an empty object representing a <code><a href="#cache-batch-operation-dictionary">CacheBatchOperation</a></code> dictionary.</li>
          <li>Set the <var>type</var> dictionary member of <var>o</var> to "put".</li>
          <li>Set the <var>request</var> dictionary member of <var>o</var> to <var>request</var>.</li>
          <li>Set the <var>response</var> dictionary member of <var>o</var> to <var>response</var>.</li>
          <li>Add <var>o</var> to <var>operations</var>.</li>
          <li>Set <var>resultPromiseArray</var> to the result of running <a href="#batch-cache-operations-algorithm">[[BatchCacheOperations]]</a> passing <var>operations</var> as the argument.</li>
          <li>Let <var>p</var> be transforming <var>resultPromiseArray</var> with <var>onFulfilled</var>.</li>
          <li>Upon fulfillment of <var>p</var> with <var>responseArray</var>, perform the following substeps, <var>onFulfilled</var>, asynchronously:
            <ol>
              <li>Resolve <var>p</var> with <var>responseArray</var>[0].</li>
            </ol>
          </li>
          <li>Return <var>p</var>.</li>
        </ol>
        </spec-algorithm>
      </spec-section>

      <spec-section id="cache-delete">
        <h1><code>delete(<var>request</var>, <var>params</var>)</code></h1>

        <p><dfn id="cache-delete-method"><code>delete(<var>request</var>, <var>params</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

        <spec-algorithm>
        <ol>
          <li>Let <var>operations</var> be an empty array.</li>
          <li>Let <var>o</var> be an empty object representing a <code><a href="#cache-batch-operation-dictionary">CacheBatchOperation</a></code> dictionary.</li>
          <li>Set the <var>type</var> dictionary member of <var>o</var> to "delete".</li>
          <li>Set the <var>request</var> dictionary member of <var>o</var> to <var>request</var>.</li>
          <li>Set the <var>matchParams</var> dictionary member of <var>o</var> to <var>params</var>.</li>
          <li>Add <var>o</var> to <var>operations</var>.</li>
          <li>Set <var>resultPromiseArray</var> to the result of running <a href="#batch-cache-operations-algorithm">[[BatchCacheOperations]]</a> passing <var>operations</var> as the argument.</li>
          <li>Let <var>p</var> be transforming <var>resultPromiseArray</var> with <var>onFulfilled</var>.</li>
          <li>Upon fulfillment of <var>p</var> with <var>responseArray</var>, perform the following substeps, <var>onFulfilled</var>, asynchronously:
            <ol>
              <li>If <var>resultPromiseArray</var> is not null, then:
                <ol>
                  <li>Resolve <var>p</var> with true.</li>
                </ol>
              </li>
              <li>Else:
                <ol>
                  <li>Resolve <var>p</var> with false.</li>
                </ol>
              </li>
            </ol>
          </li>
          <li>Return <var>p</var>.</li>
        </ol>
        </spec-algorithm>
      </spec-section>

      <spec-section id="cache-keys">
        <h1><code>keys(<var>request</var>, <var>params</var>)</code></h1>

        <p><dfn id="cache-keys-method"><code>keys(<var>request</var>, <var>params</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

        <spec-algorithm>
        <ol>
          <li>Let <var>promise</var> be a new <a href="http://goo.gl/3TobQS">promise</a>.</li>
          <li>Run these steps asynchronously:
            <ol>
              <li>Let <var>resultArray</var> be an empty array.</li>
              <li>If the optional argument <var>request</var> is omitted, then:
                <ol>
                  <li>For each Record {[[key]], [[value]]} <var>entry</var> of its <a href="#request-to-response-map-internal-interface">[[RequestToResponseMap]]</a>:
                    <ol>
                      <li>Add <var>entry</var>.[[key]] to <var>resultArray</var>.</li>
                    </ol>
                  </li>
                </ol>
              </li>
              <li>Else:
                <ol>
                  <li>Let <var>requestResponseArray</var> be the result of running <a href="#query-cache-algorithm">[[QueryCache]]</a> algorithm passing <var>request</var> and <var>params</var> as the arguments.</li>
                  <li>For each <var>requestResponse</var> in <var>requestResponseArray</var>:
                    <ol>
                      <li>Add <var>requestResponse</var>[0] to <var>resultArray</var>.</li>
                    </ol>
                  </li>
                </ol>
              </li>
              <li>Resolve <var>promise</var> with <var>resultArray</var>.</li>
            </ol>
          </li>
          <li>Return <var>promise</var>.</li>
        </ol>
        </spec-algorithm>
      </spec-section>
    </spec-section>

    <spec-section id="cache-storage">
      <h1><code>CacheStorage</code></h1>

<spec-idl>
[Exposed=ServiceWorker]
interface <dfn id="cache-storage-interface" title="CacheStorage">CacheStorage</dfn> {
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;<a href="http://fetch.spec.whatwg.org/#response">Response</a>&gt; match((<a href="http://fetch.spec.whatwg.org/#request">Request</a> or <a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a>) <var>request</var>, optional <a href="#query-params-dictionary">QueryParams</a> <var>params</var>);
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;<a href="#cache-interface">Cache</a>&gt; get(DOMString <var>cacheName</var>);
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;boolean&gt; has(DOMString <var>cacheName</var>);
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;<a href="#cache-interface">Cache</a>&gt; create(DOMString <var>cacheName</var>);
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;boolean&gt; delete(DOMString <var>cacheName</var>);
  <a href="http://goo.gl/3TobQS">Promise</a>&lt;sequence&lt;DOMString&gt;&gt; keys();
};</spec-idl>
<!--FIXME(jungkees): set method is not entirely dropped yet. <a href="http://goo.gl/3TobQS">Promise</a>&lt;any&gt; set(DOMString <var>key</var>, <a href="#cache-interface">Cache</a> <var>val</var>);-->

      <p class="note"><a href="#cache-storage-interface">CacheStorage</a> interface is designed to largely conform to <a href="http://goo.gl/gNnDPO">ECMAScript 6 Map objects</a> but entirely async, and with additional convenience methods. The methods, <code>clear</code>, <code>forEach</code>, <code>entries</code> and <code>values</code>, are intentionally excluded from the scope of the first version resorting to the ongoing discussion about the async iteration by TC39.</p>

      <p>The <code><a href="#cache-storage-interface">CacheStorage</a></code> interface represents the storage for <code><a href="#cache-interface">Cache</a></code> objects. A <code><a href="#cache-storage-interface">CacheStorage</a></code> object has a <a href="#name-to-cache-map-internal-interface">[[NameToCacheMap]]</a> object.</p>

      <spec-section id="cache-storage-match">
        <h1><code>match(<var>request</var>, <var>params</var>)</code></h1>

        <p><dfn id="cache-storage-match-method"><code>match(<var>request</var>, <var>params</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

        <spec-algorithm>
        <ol>
          <li>Let <var>cacheName</var> be null.</li>
          <li>If the optional argument <var>params</var> is not omitted, then:
            <ol>
              <li>Set <var>cacheName</var> to <var>params</var>.<var>cacheName</var>.</li>
            </ol>
          </li>
          <li>Let <var>p</var> be null.</li>
          <li>If <var>cacheName</var> is not null, then:
            <ol>
              <li>Set <var>p</var> to <a href="https://github.com/domenic/promises-unwrapping/blob/master/docs/writing-specifications-with-promises.md#manipulating-promises">transforming</a> the result of running the algorithm specified in <code><a href="#cache-storage-get-method">get(<var>cacheName</var>)</a></code> method passing <var>cacheName</var> as the argument, with <var>onFulfilled</var>.</li>
              <li><a href="https://github.com/w3ctag/promises-guide#reacting-to-promises">Upon fulfillment of <var>p</var> with value <var>cache</var></a>, perform the following substeps, <var>onFulfilled</var>, asynchronously:
                <ol>
                  <li>If <var>cache</var> is null, then:
                    <ol>
                      <li>Reject <var>p</var> with an "<code><a href="http://dom.spec.whatwg.org/#notfounderror">NotFoundError</a></code>" exception.</li>
                    </ol>
                  </li>
                  <li>Else:
                    <ol>
                      <li>Resolve <var>p</var> with the result of running the algorithm specified in <code><a href="#cache-match-method">match(<var>request</var>, <var>params</var>)</a></code> method of <code><a href="#cache-interface">Cache</a></code> interface with <var>request</var> and <var>params</var> as the arguments (providing <var>cache</var> as thisArgument to the <a href="http://people.mozilla.org/~jorendorff/es6-draft.html#sec-ecmascript-function-objects-call-thisargument-argumentslist">[[Call]]</a> internal method of <code><a href="#cache-match-method">match(<var>request</var>, <var>params</var>)</a></code>.)</li>
                    </ol>
                  </li>
                </ol>
              </li>
              <li>Return <var>p</var>.</li>
            </ol>
          </li>
          <li>Else:
            <ol>
              <li>Set <var>p</var> to <a href="https://github.com/domenic/promises-unwrapping/blob/master/docs/writing-specifications-with-promises.md#manipulating-promises">transforming</a> the result of running the algorithm specified in <code><a href="#cache-storage-keys-method">keys()</a></code> method, with <var>onFulfilled</var>.</li>
              <li><a href="https://github.com/w3ctag/promises-guide#reacting-to-promises">Upon fulfillment of <var>p</var> with value <var>keys</var></a>, perform the following substeps, <var>onFulfilled</var>, asynchronously:
                <ol>
                  <li>For each <var>key</var> in <var>keys</var>:
                    <ol>
                      <li>Let <var>q</var> be the result of running the algorithm specified in <code><a href="#cache-match-method">match(<var>request</var>, <var>params</var>)</a></code> method of <code><a href="#cache-interface">Cache</a></code> interface with <var>request</var> and <var>params</var> as the arguments (providing <var>key</var> as thisArgument to the <a href="http://people.mozilla.org/~jorendorff/es6-draft.html#sec-ecmascript-function-objects-call-thisargument-argumentslist">[[Call]]</a> internal method of <code><a href="#cache-match-method">match(<var>request</var>, <var>params</var>)</a></code>.)</li>
                      <li>Upon fulfillment of <var>q</var> with value <var>matchedResponse</var>:
                        <ol>
                          <li>Resolve <var>p</var> with <var>matchedResponse</var>.</li>
                          <li>Abort these steps.</li>
                        </ol>
                      </li>
                    </ol>
                  </li>
                  <li>Reject <var>p</var> with an "<code><a href="http://dom.spec.whatwg.org/#notfounderror">NotFoundError</a></code>" exception.</li>
                </ol>
              </li>
              <li>Return <var>p</var>.</li>
            </ol>
          </li>
        </ol>
        </spec-algorithm>
      </spec-section>

      <spec-section id="cache-storage-get">
        <h1><code>get(<var>cacheName</var>)</code></h1>

        <p><dfn id="cache-storage-get-method"><code>get(<var>cacheName</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

        <spec-algorithm>
        <ol>
          <li>Return a <a href="http://goo.gl/3TobQS">promise</a>, <var>p</var>, resolved with the result of running the following substeps. Each <code><a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> object must have a separate object for the <code><a href="#cache-interface">Cache</a></code> object which the result of running its <code><a href="#cache-storage-interface">CacheStorage</a></code>'s <code><a href="#cache-storage-get-method">get(<var>cacheName</var>)</a></code> method resolves with:
            <ol>
              <li>For each Record {[[key]], [[value]]} <var>entry</var> of its <a href="#name-to-cache-map-internal-interface">[[NameToCacheMap]]</a>:
                <ol>
                  <li>If <var>cacheName</var> matches <var>entry</var>.[[key]], then:
                    <ol>
                      <li>Return <var>entry</var>.[[value]].</li>
                    </ol>
                  </li>
                </ol>
              </li>
              <li>Return undefined.</li>
            </ol>
          </li>
        </ol>
        </spec-algorithm>
      </spec-section>

      <spec-section id="cache-storage-has">
        <h1><code>has(<var>cacheName</var>)</code></h1>

        <p><dfn id="cache-storage-has-method"><code>has(<var>cacheName</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

        <spec-algorithm>
        <ol>
          <li>Return a <a href="http://goo.gl/3TobQS">promise</a>, <var>p</var>, resolved with the result of running the following substeps:
            <ol>
              <li>For each Record {[[key]], [[value]]} <var>entry</var> of its <a href="#name-to-cache-map-internal-interface">[[NameToCacheMap]]</a>:
                <ol>
                  <li>If <var>cacheName</var> matches <var>entry</var>.[[key]], then:
                    <ol>
                      <li>Return true.</li>
                    </ol>
                  </li>
                </ol>
              </li>
              <li>Return false.</li>
            </ol>
          </li>
        </ol>
        </spec-algorithm>
      </spec-section>

      <spec-section id="cache-storage-create">
        <h1><code>create(<var>cacheName</var>)</code></h1>

        <p><dfn id="cache-storage-create-method"><code>create(<var>cacheName</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

        <spec-algorithm>
        <ol>
          <li>Let <var>p</var> be the result of running the algorithm specified in <code><a href="">has(<var>cacheName</var>)</a></code> method with <var>cacheName</var> as the argument.</li>
          <li>Let <var>q</var> be transforming <var>p</var> with <var>onFulfilled</var>.</li>
          <li>Upon fulfillment of <var>p</var> with value <var>cacheExists</var>, perform the following substeps, <var>onFulfilled</var>, asynchronously:
            <ol>
              <li>If <var>cacheExists</var> is true, then:
                <ol>
                  <li>Reject <var>q</var> with an "<code><a href="http://dom.spec.whatwg.org/#invalidaccesserror">InvalidAccessError</a></code>" exception.</li>
                  <li>Abort these steps.</li>
                </ol>
              </li>
              <li>Let <var>cache</var> be a new <a href="#cache-interface">Cache</a> object.</li>
              <li>Set a newly-created Record {[[key]]: <var>cacheName</var>, [[value]]: <var>cache</var>} to <a href="#name-to-cache-map-internal-interface">[[NameToCacheMap]]</a>.</li>
              <li>Resolve <var>q</var> with <var>cache</var>.</li>
            </ol>
          </li>
          <li>Return <var>q</var>.</li>
        </ol>
        </spec-algorithm>
      </spec-section>

      <spec-section id="cache-storage-delete">
        <h1><code>delete(<var>cacheName</var>)</code></h1>

        <p><dfn id="cache-storage-cacheName-method"><code>delete(<var>cacheName</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

        <spec-algorithm>
        <ol>
          <li>Let <var>p</var> be the result of running the algorithm specified in <code><a href="">has(<var>cacheName</var>)</a></code> method with <var>cacheName</var> as the argument.</li>
          <li>Let <var>q</var> be transforming <var>p</var> with <var>onFulfilled</var>.</li>
          <li>Upon fulfillment of <var>p</var> with value <var>cacheExists</var>, perform the following substeps, <var>onFulfilled</var>, asynchronously:
            <ol>
              <li>If <var>cacheExists</var> is true, then:
                <ol>
                  <li>Delete a Record {[[key]], [[value]]} <var>entry</var> of its <a href="#name-to-cache-map-internal-interface">[[NameToCacheMap]]</a> where <var>cacheName</var> matches entry.[[key]].</li>
                  <li>Resolve <var>q</var> with true.</li>
                  <li>Abort these steps.</li>
                </ol>
              </li>
              <li>Else:
                <ol>
                  <li>Resolve <var>q</var> with flase.</li>
                </ol>
              </li>
            </ol>
          </li>
          <li>Return <var>q</var>.</li>
        </ol>
        </spec-algorithm>
      </spec-section>

      <spec-section id="cache-storage-keys">
        <h1><code>keys()</code></h1>

        <p><dfn id="cache-storage-keys-method"><code>keys()</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>

        <spec-algorithm>
        <ol>
          <li>Let <var>resultArray</var> be an empty array.</li>
          <li>Return a <a href="http://goo.gl/3TobQS">promise</a>, <var>p</var>, resolved with the result of running the following substeps:
            <ol>
              <li>For each Record {[[key]], [[value]]} <var>entry</var> of its <a href="#name-to-cache-map-internal-interface">[[NameToCacheMap]]</a>:
                <ol>
                  <li>Add <var>entry</var>.[[key]] to <var>resultArray</var>.</li>
                </ol>
              </li>
              <li>Return <var>resultArray</var>.</li>
            </ol>
          </li>
        </ol>
        </spec-algorithm>
      </spec-section>
    </spec-section>
  </spec-section>

  <spec-section id="install-phase-event">
    <h1><code>InstallPhaseEvent</code></h1>

<spec-idl>
[Constructor(DOMString <var>type</var>, optional <a href="http://goo.gl/AbWMT8">EventInit</a> <var>eventInitDict</var>), Exposed=ServiceWorker]
interface <dfn id="install-phase-event-interface" title="InstallPhaseEvent">InstallPhaseEvent</dfn> : <a href="http://goo.gl/UVs0Yt">Event</a> {
void <a href="#install-phase-event-waituntil-method">waitUntil</a>(<a href="http://goo.gl/3TobQS">Promise</a>&lt;any&gt; <var>f</var>);
};
</spec-idl>

    <p>Service Workers have two <a href="#dfn-lifecycle-events">Lifecycle events</a>, <code><a href="#install-event">install</a></code> and <code><a href="#activate-event">activate</a></code>. Service Workers use the <code><a href="#install-phase-event-interface">InstallPhaseEvent</a></code> interface for <code><a href="#activate-event">activate</a></code> event and the <code><a href="#install-event-interface">InstallEvent</a></code> interface, which inherits from the <code><a href="#install-phase-event-interface">InstallPhaseEvent</a></code> interface, for <code><a href="#install-event">install</a></code> event.</p>

    <p>Each event using <code><a href="#install-phase-event-interface">InstallPhaseEvent</a></code> interface or a derived interface has the following associated flags that are all initially unset:
      <ul>
        <li><dfn id="extend-lifetime-flag">extend lifetime flag</dfn></li>
        <li><dfn id="wait-until-reject-flag">wait-until reject flag</dfn></li>
      </ul>
    </p>

    <spec-section id="wait-until-method">
      <h1><code>event.waitUntil(f)</code></h1>

      <p><a href="#install-phase-event-waituntil-method"><code>waitUntil(<var>f</var>)</code></a> method, when called in <code><a href="#service-worker-global-scope-oninstall-attribute">oninstall</a></code> or <code><a href="#service-worker-global-scope-onactivate-attribute">onactivate</a></code>, extends the lifetime of the event. When called in <code><a href="#service-worker-global-scope-oninstall-attribute">oninstall</a></code>, it delays treating the installing worker until the passed <a href="http://goo.gl/3TobQS">promise</a> resolves successfully. This is primarily used to ensure that a <code><a href="#service-worker-interface">ServiceWorker</a></code> is not active until all of the core caches it depends on are populated. When called in <code><a href="#service-worker-global-scope-onactivate-attribute">onactivate</a></code>, it delays treating the activating worker until the passed <a href="http://goo.gl/3TobQS">promise</a> resolves successfully. This is primarily used to ensure that any <a href="#dfn-functional-events">Functional events</a> are not dispatched to the <code><a href="#service-worker-interface">ServiceWorker</a></code> until it upgrades database schemas and deletes the outdated cache entries.</p>

      <p><dfn id="install-phase-event-waituntil-method"><code>waitUntil(<var>f</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>
      <spec-algorithm>
      <ol>
        <li>Set the <a href="#extend-lifetime-flag">extend lifetime flag</a>.</li>
        <li>Wait until <var>f</var> settles.</li>
        <li>If <var>f</var> rejects with an exception, then:
          <ol>
            <li><a href="http://dom.spec.whatwg.org/#concept-throw">Throw</a> that exception.</li>
            <li>Set the <a href="#wait-until-reject-flag">wait-until reject flag</a>.</li>
          </ol>
        </li>
        <li>Else if <var>f</var> resolves with a value, then:
          <ol>
            <li>Do nothing.</li>
          </ol>
        </li>
        <li>Unset the <a href="#extend-lifetime-flag">extend lifetime flag</a>.</li>
      </ol>
      </spec-algorithm>
    </spec-section>
  </spec-section>

  <spec-section id="install-event-section">
    <h1><code>InstallEvent</code></h1>

<spec-idl>
[Constructor(DOMString <var>type</var>, optional <a href="#install-event-init-dictionary">InstallEventInit</a> <var>eventInitDict</var>), Exposed=ServiceWorker]
interface <dfn id="install-event-interface" title="InstallEvent">InstallEvent</dfn> : <a href="#install-phase-event-interface">InstallPhaseEvent</a> {
readonly attribute <a href="#service-worker-interface">ServiceWorker</a>? <a href="#install-event-activeworker-attribute">activeWorker</a>;
void <a href="#install-event-replace-method">replace</a>();
};

dictionary <dfn id="install-event-init-dictionary" title="InstallEventInit">InstallEventInit</dfn> : <a href="http://goo.gl/AbWMT8">EventInit</a> {
<a href="#service-worker-interface">ServiceWorker</a> activeWorker;
};
</spec-idl>

    <p>Each event using <code><a href="#install-event-interface">InstallEvent</a></code> interface has the following associated flag that is initially unset:
    <ul>
      <li><dfn id="activate-immediate-flag">activate immediate flag</dfn></li>
    </ul></p>

    <spec-section id="replace-method">
      <h1><code>event.replace()</code></h1>

      <p><code><a href="#install-event-replace-method">event.replace()</a></code> method interacts with <code><a href="#install-phase-event-waituntil-method">event.waitUntil(<var>f</var>)</a></code> method. Successful installation can be delayed by <code><a href="#install-phase-event-waituntil-method">event.waitUntil(<var>f</var>)</a></code>. Replacement only happens upon successful installation. That is, replacement of the <a href="#dfn-active-worker">active worker</a> (if any) by invoking <code><a href="#install-event-replace-method">event.replace()</a></code> method is not immediate, but it may occur as soon as the event's <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-handlers">event handler</a> completes its execution which is extended by <code><a href="#install-phase-event-waituntil-method">event.waitUntil(<var>f</var>)</a></code>.</p>

      <p><dfn id="install-event-replace-method"><code>replace()</code></dfn> method must set the <a href="#activate-immediate-flag">activate immediate flag</a>.</p>

    </spec-section>
  </spec-section>

  <spec-section id="fetch-event-section">
    <h1><code>FetchEvent</code></h1>

<spec-idl>
[Constructor(DOMString <var>type</var>, optional <a href="#fetch-event-init-dictionary">FetchEventInit</a> <var>eventInitDict</var>), Exposed=ServiceWorker]
interface <dfn id="fetch-event-interface" title="FetchEvent">FetchEvent</dfn> : <a href="http://goo.gl/UVs0Yt">Event</a> {
readonly attribute <a href="http://fetch.spec.whatwg.org/#request">Request</a> request;
readonly attribute <a href="#service-worker-client-interface">ServiceWorkerClient</a> client; // The window issuing the request.
readonly attribute <a href="#context-enum">Context</a> context;
readonly attribute boolean <a href="#fetch-event-isreload-attribute">isReload</a>;

void <a href="#fetch-event-respondwith-method">respondWith</a>(<a href="http://goo.gl/3TobQS">Promise</a>&lt;<a href="http://fetch.spec.whatwg.org/#response">Response</a>&gt; <var>r</var>);
<a href="http://goo.gl/3TobQS">Promise</a>&lt;<a href="http://fetch.spec.whatwg.org/#response">Response</a>&gt; forwardTo(<a href="http://encoding.spec.whatwg.org/#scalarvaluestring">ScalarValueString</a> <var>url</var>);
<a href="#promise-interface">Promise</a>&lt;<a href="http://fetch.spec.whatwg.org/#response">Response</a>&gt; <a href="#fetch-event-default-method">default</a>();
};

dictionary <dfn id="fetch-event-init-dictionary" title="FetchEventInit">FetchEventInit</dfn> : <a href="http://goo.gl/AbWMT8">EventInit</a> {
<a href="http://fetch.spec.whatwg.org/#request">Request</a> request;
<a href="#service-worker-client-interface">ServiceWorkerClient</a> client;
<a href="#context-enum">Context</a> context;
boolean isReload;
};

enum <dfn id="context-enum" title="Context">Context</dfn> {
"connect",
"font",
"img",
"object",
"script",
"style",
"worker",
"popup",
"child",
"navigate"
};
</spec-idl>

    <p>Each event using <code><a href="#fetch-event-interface">FetchEvent</a></code> interface has the following associated flag that is initially unset:
      <ul>
        <li><dfn id="wait-to-respond-flag">wait to respond flag</dfn></li>
        <li><dfn id="respond-with-entered-flag">respond-with entered flag</dfn></li>
        <li><dfn id="respond-with-error-flag">respond-with error flag</dfn></li>
      </ul>
    </p>

    <spec-section id="respond-with-method">
      <h1><code>event.respondWith(r)</code></h1>

      <p>When <code><a href="#fetch-event-respondwith-method">event.respondWith(<var>r</var>)</a></code> method is invoked, the argument, <var>r</var>, must resolve with a <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code>, else a <a href="http://w3c.github.io/dom/#networkerror">NetworkError</a> is <a href="http://dom.spec.whatwg.org/#concept-throw">thrown</a>. If the request is a top-level navigation and the return value is a <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code> whose <code>type</code> attribute is "<code>opaque</code>" (i.e., an opaque response body), a <a href="http://w3c.github.io/dom/#networkerror">NetworkError</a> is <a href="http://dom.spec.whatwg.org/#concept-throw">thrown</a>. The final URL of all successful (non network-error) responses is the <a href="#request-objects">requested</a> URL. Renderer-side security checks about tainting for cross-origin content are tied to the transparency (or opacity) of the <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code> body, not URLs.</p>

      <p><dfn id="fetch-event-respondwith-method"><code>respondWith(<var>r</var>)</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>
      <spec-algorithm>
      <ol>
        <li>If the <a href="#respond-with-entered-flag">respond-with entered flag</a> is set, then:
          <ol>
            <li><a href="http://dom.spec.whatwg.org/#concept-throw">Throw</a> an "<code><a href="http://dom.spec.whatwg.org/#invalidstateerror">InvalidStateError</a></code>" exception.</li>
            <li>Abort these steps.</li>
          </ol>
        </li>
        <li>Set the <a href="#respond-with-entered-flag">respond-with entered flag</a>.</li>
        <li>Set the <a href="#wait-to-respond-flag">wait to respond flag</a>.</li>
        <li>Wait until <var>r</var> settles.</li>
        <li>If <var>r</var> rejected with an exception, then:
          <ol>
            <li>Set the <a href="#respond-with-error-flag">respond-with error flag</a>.</li>
            <li><a href="http://dom.spec.whatwg.org/#concept-throw">Throw</a> that exception.</li>
          </ol>
        </li>
        <li>If <var>r</var> resolves to <var>response</var>, an instance of <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code> interface whose <code>type</code> attribute is "<code>opaque</code>", and the <code><a href="#context-enum">context</a></code> attribute is "<code>navigate</code>", then:
          <ol>
            <li>Set the <a href="#respond-with-error-flag">respond-with error flag</a>
            <li><a href="http://dom.spec.whatwg.org/#concept-throw">Throw</a> a "<code><a href="http://dom.spec.whatwg.org/#networkerror">NetworkError</a></code>" exception.</li>
          </ol>
        </li>
        <li>If <var>r</var> resolves to <var>response</var>, an instance of <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code> interface, then:
          <ol>
            <li>Do nothing.</li>
          </ol>
        </li>
        <li>Unset the <a href="#wait-to-respond-flag">wait to respond flag</a>.</li>
      </ol>
      </spec-algorithm>
    </spec-section>

    <spec-section id="default-method">
      <h1><code>event.default()</code></h1>

      <p>The invocation of <code><a href="#fetch-event-default-method">event.default()</a></code> method performs a <a href="http://fetch.spec.whatwg.org/#concept-fetch">fetch</a> using <code><a href="#FIXME(jungkees)">event.request</a></code>. <code><a href="#FIXME(jungkees)">event.request</a></code> represents the original request from the <a href="#dfn-document-control">controlled</a> document. During the execution, the original request is not altered (except the <a href="http://fetch.spec.whatwg.org/#skip-service-worker-flag">skip service worker flag</a>), and thus <code><a href="#fetch-event-default-method">event.default()</a></code> fetches the original request through the UA's HTTP stack. <code><a href="#fetch-event-default-method">event.default()</a></code> returns a promise, which resolves with a <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code> object, that can be an argument to the <code><a href="#fetch-event-respondwith-method">event.respondWith(<var>r</var>)</a></code> method.</p>

      <p><dfn id="fetch-event-default-method"><code>default()</code></dfn> method must run these steps or their <a href="#dfn-processing-equivalence">equivalent</a>:</p>
      <spec-algorithm>
      <ol>
        <li>Let <var>promise</var> be a new <a href="http://goo.gl/3TobQS">promise</a>.</li>
        <li>Run the following substeps asynchronously:
          <ol>
            <li>Let <var>request</var> be <var>event</var>'s <var>request</var>.</li>
            <li>Set <var>request</var>'s <a href="http://goo.gl/gP7IWW">skip service worker flag</a>.</li>
            <li>Let <var>response</var> be the result of running <a href="http://goo.gl/fGMifs">fetch algorithm</a> with <var>request</var> as its argument.</li>
            <li>If <var>response</var> is a <a href="http://goo.gl/jprjjc">network error</a>, then:
              <ol>
                <li>Reject <var>promise</var> with a <code>TypeError</code>.</li>
              </ol>
            </li>
            <li>Else,
              <ol>
                <li>Resolve <var>promise</var> with a new <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code> object associated with <var>response</var>.</li>
              </ol>
            </li>
          </ol>
        </li>
        <li>Return <var>promise.</var></li>
      </ol>
      </spec-algorithm>
    </spec-section>

    <spec-section id="is-reload-attribute">
      <h1><code>event.isReload</code></h1>

      <p><dfn id="fetch-event-isreload-attribute"><code>isReload</code></dfn> attribute must return true if <var>event</var> was dispatched with the user's intention for the page reload, and false otherwise. Pressing the refresh button should be considered a reload while clicking a link and pressing the back button should not. The behavior of the <var>Ctrl+l enter</var> is left to the implementations of the user agents.</p>
    </spec-section>
  </spec-section>

  <spec-section id="execution-context-events">
    <h1>Events</h1>

    <p>The following events are dispatched on <a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a> object:</p>

    <table>
      <thead>
        <tr>
          <th>Event name</th>
          <th>Interface</th>
          <th>Dispatched when&mldr;</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><dfn id="service-worker-global-scope-install-event"><code>install</code></dfn></td>
          <td><code><a href="#install-event-interface">InstallEvent</a></code></td>
          <td>[<a href="#dfn-lifecycle-events">Lifecycle event</a>] A <a href="#dfn-registration">registration</a>'s installing Service Worker enters the <a href="#installing-process">installation process</a>. (See step 7-1 of the <a href="#installation-algorithm">[[Install]]</a> algorithm.)</td>
        </tr>
        <tr>
          <td><dfn id="service-worker-global-scope-activate-event"><code>activate</code></dfn></td>
          <td><code><a href="#install-phase-event-interface">InstallPhaseEvent</a></code></td>
          <td>[<a href="#dfn-lifecycle-events">Lifecycle event</a>] A <a href="#dfn-registration">registration</a>'s activating Service Worker enters the <a href="#dfn-activation-process">activation process</a>. (See step 9-1 of the <a href="#activation-algorithm">[[Activate]]</a> algorithm.)</td>
        </tr>
        <tr>
          <td><dfn id="service-worker-global-scope-fetch-event"><code>fetch</code></dfn></td>
          <td><code><a href="#fetch-event-interface">FetchEvent</a></code></td>
          <td>[<a href="#dfn-functional-events">Functional event</a>] <a href="http://fetch.spec.whatwg.org/">Fetch</a> invokes <a href="#handle-a-fetch">handle a fetch</a> with <var>request</var>. As a result of performing <a href="#handle-a-fetch">handle a fetch</a>, the Service Woker returns a <a href="http://fetch.spec.whatwg.org/#concept-response">response</a> to <a href="http://fetch.spec.whatwg.org/">Fetch</a>. The <a href="http://fetch.spec.whatwg.org/#concept-response">response</a>, represented by a <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code> object, can be retrieved from a <a href="#cache-interface">Cache</a> object or directly from network using <code><a href="#service-worker-global-scope-fetch-method">self.fetch(<var>input</var>, <var>init</var>)</a></code> method or <code><a href="#fetch-event-default-method">event.default()</a></code> method. (A custom <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code> object can be another option.)</td>
        </tr>
      </tbody>
    </table>

    <p class="note">Custom event types for <dfn id="service-worker-global-scope-beforeevicted-event">beforeevicted</dfn> and <dfn id="service-worker-global-scope-evicted-event">evicted</dfn> should be added.</p>
  </spec-section>
</spec-clause>

<spec-clause id="security-considerations">
  <h1>Security Considerations</h1>

  <p>Service Workers should be implemented to be HTTPS-only. The reasons for SSL-only support include:</p>
  <ul>
    <li>Better to protect end users from man-in-the-middle attacks</li>
    <li>Do good by encouraging HTTPS adoption</li>
    <li>Existing "playground" services (e.g. github.io) now work with HTTPS</li>
    <li>HTTPS is coming across much more of the web quickly</li>
    <li>Devtools can loosen the restriction for development (file://, localhost, etc.)</li>
  </ul>

  <p class="fixme">The section will be updated.</p>

  <spec-section id="origin-relativity">
    <h1>Origin Relativity</h1>

    <p>One of the advanced concerns that major applications would encounter is whether they can be hosted from a CDN. By definition, these are servers in other places, often on other domains. Therefore, Service Workers cannot be hosted on CDNs. But they can include resources via <a href="http://goo.gl/Owcfs2">importScripts()</a>. The reason for this restriction is that Service Workers create the opportunity for a bad actor to turn a bad day into a bad eternity.</p>
    <p class="fixme">The section will be updated.</p>
  </spec-section>

  <spec-section id="cross-origin-resources">
    <h1>Cross-Origin Resources &amp; CORS</h1>

    <p>Applications tend to cache items that come from a CDN or other domain. It is possible to request many of them directly using &lt;script&gt;, &lt;img&gt;, &lt;video&gt; and &lt;link&gt; elements. It would be hugely limiting if this sort of runtime collaboration broke when offline. Similarly, it is possible to XHR many sorts of off-domain resources when appropriate CORS headers are set.</p>
    <p>ServiceWorkers enable this by allowing <code><a href="#cache-interface">Cache</a></code>s to fetch and cache off-origin items. Some restrictions apply, however. First, unlike same-origin resources which are managed in the <code><a href="#cache-interface">Cache</a></code> as <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code> objects with the <code>type</code> attribute set to "<code>basic</code>", the objects stored are <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code> objects with the <code>type</code> attribute set to "<code>opaque</code>". <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code>s typed "<code>opaque</code>" provide a much less expressive API than <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code>s typed "<code>basic</code>"; the bodies and headers cannot be read or set, nor many of the other aspects of their content inspected. They can be passed to <code><a href="#fetch-event-respondwith-method">event.respondWith(<var>r</var>)</a></code> method and <code><a href="#FIXME(jungkees)">event.forwardTo(<var>url</var>)</a></code> method in the same manner as the <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code>s typed "<code>basic</code>", but cannot be meaningfully created programmatically. These limitations are necessary to preserve the security invariants of the platform. Allowing <code><a href="#cache-interface">Cache</a></code>s to store them allows applications to avoid re-architecting in most cases.</p>
    <p class="fixme">The section will be updated.</p>
  </spec-section>
</spec-clause>

<spec-clause id="storage-considerations">
  <h1>Storage Considerations</h1>

  <p>Service Workers should take a dependency on <a href="http://www.w3.org/TR/quota-api/">Quota Management</a> in preparation for an extension event that communicates storage pressure and pre-eviction information to the application.</p>
  <p class="fixme">The section will be updated.</p>
</spec-clause>

<spec-clause id="extensibility">
  <h1>Extensibility</h1>

  <p>The expectation is that Service Workers are meant to be extensible from other specifications. As of now, <a href="https://github.com/slightlyoff/BackgroundSync">BackgroundSync</a> event, <a href="http://www.w3.org/2012/sysapps/web-alarms/">TaskScheduler</a> and <a href="https://dvcs.w3.org/hg/push/raw-file/tip/index.html">Push API</a> would be the prime candidates and more will come. That said, we want to make sure that the future works won't be adding synchronous cruft, etc. This section will provide template text for how to extend the Service Workers.</p>
  <p class="fixme">The section will be updated.</p>
</spec-clause>

<spec-clause id="algorithms">
  <h1>Appendix A: Algorithms</h1>

  <p>The double square bracket notation (<strong>[[</strong><em>name of method</em> or <em>name of property</em><strong>]]</strong>) is used throughout the specification to indicate user agent's internal methods and internal properties.</p>
  <spec-algorithm>
  <p><dfn id="service-worker-registration-map-internal-interface">[[ScopeToRegistrationMap]]</dfn> represents an internal map structure that stores the entries of the Record {[[key]], [[value]]} where [[key]] is a string that represents a <a href="#dfn-url-scope">URL scope</a> and [[value]] is a <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object.</p>

  <p><dfn id="request-to-response-map-internal-interface">[[RequestToResponseMap]]</dfn> represents an internal map structure that stores the entries of the Record {[[key]], [[value]]} where [[key]] is a <code><a href="http://fetch.spec.whatwg.org/#request">Request</a></code> and [[value]] is a <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code>.</p>

  <p><dfn id="name-to-cache-map-internal-interface">[[NameToCacheMap]]</dfn> represents an internal map structure that stores the entries of the Record {[[key]], [[value]]} where [[key]] is a string that represents a name of the <code><a href="#cache-interface">Cache</a></code> object and [[value]] is a <code><a href="#cache-interface">Cache</a></code> object.</p>
  </spec-algorithm>

  <spec-section id="register-algorithm">
    <h1>[[Register]]</h1>

    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>document</var>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#the-document-object"><code>Document</code></a></dd>
        <dd><var>scriptURL</var>, a string that represents the URL of the script</dd>
        <dd><var>scope</var>, a string that represents a <a href="#dfn-path-prefix">path prefix</a> or a <a href="#dfn-url-scope">URL scope</a></dd>
      <dt>Output</dt>
        <dd><var>promise</var>, a <a href="http://goo.gl/3TobQS">promise</a></dd>
    </dl>
    <ol>
      <li>Let <var>scope</var> be the result of running the <a href="http://url.spec.whatwg.org/#concept-url-parser">URL parser</a> on <var>scope</var> with <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#entry-settings-object">entry settings object</a>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/#api-base-url">API base URL</a>.</li>
      <li>Set <var>scope</var> to the result of running the <a href="http://url.spec.whatwg.org/#concept-url-serializer">URL serializer</a> on <var>scope</var> with the <a href="#FIXME(jungkees):to-the-exclude-fragment-flag-in-Fetch">exclude fragment flag</a> set.</li>
      <li>Let <var>scriptURL</var> be the result of running the <a href="http://url.spec.whatwg.org/#concept-url-parser">URL parser</a> on <var>scriptURL</var> with <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#entry-settings-object">entry settings object</a>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/#api-base-url">API base URL</a>.</li>
      <li>If the <a href="http://www.whatwg.org/specs/web-apps/current-work/#origin">origin</a> of <var>scriptURL</var> is not <a href="http://www.w3.org/TR/mixed-content/#potentially-secure-origin">potentially secure</a>, then:<p class="note">Browsers may ignore this potentially secure origin rule for development purposes only.</p>
        <ol>
          <li>Return a <a href="http://goo.gl/3TobQS">promise</a> rejected with a "<code><a href="http://dom.spec.whatwg.org/#securityerror">SecurityError</a></code>" exception.</li>
        </ol>
      </li>
      <li>If the <a href="http://www.whatwg.org/specs/web-apps/current-work/#origin">origin</a> of <var>scriptURL</var> does not match <var>document</var>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/#origin">origin</a>, then:
        <ol>
          <li>Return a <a href="http://goo.gl/3TobQS">promise</a> rejected with a "<code><a href="http://dom.spec.whatwg.org/#securityerror">SecurityError</a></code>" exception.</li>
        </ol>
      </li>
      <li>If the <a href="http://www.whatwg.org/specs/web-apps/current-work/#origin">origin</a> of <var>scope</var> does not match <var>document</var>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/#origin">origin</a>, then:
        <ol>
          <li>Return a <a href="http://goo.gl/3TobQS">promise</a> rejected with a "<code><a href="http://dom.spec.whatwg.org/#securityerror">SecurityError</a></code>" exception.</li>
        </ol>
      </li>
      <li>Run the following substeps atomically:
        <ol>
          <li>Let <var>registration</var> be the result of running the <a href="#get-registration-algorithm">[[GetRegistration]]</a> algorithm passing <var>scope</var> as the argument.</li>

          <li>If <var>registration</var> is not null, then:
            <ol>
              <li>If <var>scriptURL</var> is equal to <var>registration</var>.<a href="#script-url-internal-property">[[ScriptURL]]</a>, then:
                <ol>
                  <li>If <var>registration</var>.<a href="#pending-registration-promise-internal-property">[[PendingRegistrationPromise]]</a> is not null, then:
                    <ol>
                      <li>Reject <var>registration</var>.<a href="#pending-registration-promise-internal-property">[[PendingRegistrationPromise]]</a> with an "<code><a href="http://dom.spec.whatwg.org/#aborterror">AbortError</a></code>" exception.</li>
                      <li>Set <var>registration</var>.<a href="#pending-registration-promise-internal-property">[[PendingRegistrationPromise]]</a> to null.</li>
                    </ol>
                  </li>
                  <li>Set <var>registration</var>.<a href="#upinstalling-internal-property">[[Uninstalling]]</a> to false.</li>
                  <li>Let <var>newestWorker</var> be the result of running the <a href="#get-newest-worker-algorithm">[[GetNewestWorker]]</a> algorithm passing <var>registration</var> as the argument.</li>
                  <li>If <var>newestWorker</var> is not null, and <var>scriptURL</var> is equal to <var>newestWorker</var>.<var>scriptURL</var>, then:
                    <ol>
                      <li>Return a <a href="http://goo.gl/3TobQS">promise</a> resolved with <var>registration</var>.</li>
                    </ol>
                  </li>
                </ol>
              </li>
              <li>Else:
                <ol>
                  <li>If <var>registration</var>.<a href="#upinstalling-internal-property">[[Uninstalling]]</a> is true, then:
                    <ol>
                      <li>If registration.<a href="#pending-registration-promise-internal-property">[[PendingRegistrationPromise]]</a> is not null, then:
                        <ol>
                          <li>Reject registration.<a href="#pending-registration-promise-internal-property">[[PendingRegistrationPromise]]</a> with an "<code><a href="http://dom.spec.whatwg.org/#aborterror">AbortError</a></code>" exception.</li>
                        </ol>
                      </li>
                      <li>Set <var>registration</var>.<a href="#pending-registration-promise-internal-property">[[PendingRegistrationPromise]]</a> to <var>promise</var>.</li>
                      <li>Wait until the Record {[[key]], [[value]]} <var>entry</var> of its <a href="#service-worker-registration-map-internal-interface">[[ScopeToRegistrationMap]]</a> where <var>registation</var>.<var>scope</var> matches <var>entry</var>.[[key]] is deleted.</li>
                      <li>Set <var>registration</var> to the result of running <a href="#set-registration-algorithm">[[SetRegistration]]</a> algorithm passing <var>scope</var> as its argument.</li>
                    </ol>
                  </li>
                </ol>
              </li>
            </ol>
          </li>
          <li>Else:
            <ol>
              <li>Set <var>registration</var> to the result of running <a href="#set-registration-algorithm">[[SetRegistration]]</a> algorithm passing <var>scope</var> as its argument.</li>
            </ol>
          </li>
          <li>Set <var>registration</var>.<a href="#script-url-internal-property">[[ScriptURL]]</a> to <var>scriptURL</var>.</li>
          <li>Set <var>registration</var>.<a href="#upinstalling-internal-property">[[Uninstalling]]</a> to false.</li>
          <li>Return the result of running the <a href="#update-algorithm">[[Update]]</a> algorithm, or its <a href="#dfn-processing-equivalence">equivalent</a>, passing <var>registration</var> as the argument.</li>
        </ol>
      </li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="update-algorithm">
    <h1>[[Update]]</h1>

    <p>The <a href="#update-algorithm">[[Update]]</a> algorithm, run by the user agent, upgrades an <a href="#dfn-active-worker">active worker</a> to a new version for the same <a href="#dfn-url-scope">URL scope</a>. If successful, the newly installed Service Worker becomes the <a href="#dfn-worker-in-waiting">worker in waiting</a> which later becomes the <a href="#dfn-active-worker">active worker</a> as soon as all the documents served by the previous Service Worker are closed. When scheduling a fetch of a new version, the user agent should honor the HTTP cache headers with the upper limit of 24 hours:</p>

  <!--
  #FIXME: (Checkpoint) This is a platform implmentation not exposing APIs to userland. As such, promise is not used for its output.
  -->
    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>registration</var>, a <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object</dd>
      <dt>Output</dt>
        <dd><var>promise</var>, a <a href="http://goo.gl/3TobQS">promise</a></dd>
    </dl>
    <ol>
      <li>Perform a fetch of <var>registration</var>.<a href="#script-url-internal-property">[[ScriptURL]]</a>, forcing a network fetch if cached entry is greater than 1 day old.</li>
      <li>If fetching the script fails due to the server returning a 4xx response or a 5xx response, or there is a DNS error, or the connection times out, then:
        <ol>
          <li>Return a <a href="http://goo.gl/3TobQS">promise</a> rejected with a "<code><a href="http://dom.spec.whatwg.org/#networkerror">NetworkError</a></code>" exception.</li>
        </ol>
      </li>
      <li>Else if the server returned a redirect, then:
        <ol>
          <li>Return a <a href="http://goo.gl/3TobQS">promise</a> rejected with a "<code><a href="http://dom.spec.whatwg.org/#securityerror">SecurityError</a></code>" exception.</li>
        </ol>
      </li>
      <li><a href="http://fetch.spec.whatwg.org/#concept-header-extract-mime-type">Extract a MIME type</a> from the header list of the fetch response. If this MIME type (ignoring parameters) is not one of <code>text/javascript</code>, <code>application/x-javascript</code>, or <code>application/javascript</code>, then:
        <ol>
          <li>Return a <a href="http://goo.gl/3TobQS">promise</a> rejected with a "<code><a href="http://dom.spec.whatwg.org/#securityerror">SecurityError</a></code>" exception.</li>
        </ol>
      </li>
      <li>Let <var>fetchedScript</var> be the fetched script.</li>
      <li>Let <var>newestWorker</var> be the result of running the <a href="#get-newest-worker-algorithm">[[GetNewestWorker]]</a> algorithm passing <var>registration</var> as the argument.</li>
      <li>If <var>newestWorker</var> is not null, and <var>newestWorker</var>.<var>scriptURL</var> is equal to <var>registration</var>.<a href="#script-url-internal-property">[[ScriptURL]]</a> and <var>fetchedScript</var> is a byte-for-byte match with the script of <var>newestWorker</var>, then:
        <ol>
          <li>Return a <a href="http://goo.gl/3TobQS">promise</a> resolved with <var>registration</var>.</li>
        </ol>
      </li>
      <li>Else,
        <ol>
          <li>Let <var>worker</var> be a new <code><a href="#service-worker-interface">ServiceWorker</a></code> object, using <var>fetchedScript</var>.</li>
          <li>If <var>worker</var> fails to start up, due to parse errors or uncaught errors, then:
            <ol>
              <li>Return a <a href="http://goo.gl/3TobQS">promise</a> rejected with the error.</li>
            </ol>
          </li>
          <li>Return the result of running <a href="#installation-algorithm">[[Install]]</a> algorithm, or its <a href="#dfn-processing-equivalence">equivalent</a>, with <var>registration</var> and <var>worker</var> as its arguments.</li>
        </ol>
      </li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="soft-update-algorithm">
    <h1>[[SoftUpdate]]</h1>

    <p>The user agent may call this as often as it likes to check for updates.</p>

    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>registration</var>, a <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object</dd>
      <dt>Output</dt>
        <dd>None</dd>
    </dl>
    <ol>
      <li>If <var>registration</var>.<a href="#upinstalling-internal-property">[[Uninstalling]]</a> is true, then:
        <ol>
          <li>Abort these steps.</li>
        </ol>
      </li>
      <li>If <var>registration</var>.<var>installing</var> is not null, then:
        <ol>
          <li>Abort these steps.</li>
        </ol>
      </li>
      <li>Invoke <a href="#update-algorithm">[[Update]]</a> algorithm, or its <a href="#dfn-processing-equivalence">equivalent</a>, with <var>registration</var> as its argument.</li>
    </ol>
    </spec-algorithm>
    <P class="fixme">Inspect whether the <var>promise</var> returned from <a href="#update-algorithm">[[Update]]</a> algorithm should be returned to the caller (either UA internal context or <code><a href="#service-worker-global-scope-update-method">self.update()</a></code>).</P>
  </spec-section>

  <spec-section id="installation-algorithm">
    <h1>[[Install]]</h1>

    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>registration</var>, a <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object</dd>
        <dd><var>worker</var>, a <code><a href="#service-worker-interface">ServiceWorker</a></code> object</dd>
      <dt>Output</dt>
        <dd><var>promise</var>, a <a href="http://goo.gl/3TobQS">promise</a></dd>
    </dl>
    <ol>
      <li>Let <var>installFailed</var> be false.</li>
      <li>Let <var>activateImmediate</var> be false.</li>
      <li>Let <var>promise </var> be a new <a href="http://goo.gl/3TobQS">promise</a>.</li>
      <li>Run the following substeps asynchronously:
        <ol>
          <li>Run the following substeps atomically:
            <ol>
              <li>If <var>registration</var>.<var>installing</var> is not null, then:
                <ol>
                  <li><a href="http://goo.gl/fkJaja">Terminate</a> <var>registration</var>.<var>installing</var>.</li>
                  <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>registration</var>.<var>installing</var> and "<code>redundant</code>" as the arguments.</li>
                  <li>Set <var>registration</var>.<var>installing</var> to null.</li>
                  <li>The user agent may abort any in-flight requests triggered by <var>registration</var>.<var>installing</var>.</li>
                </ol>
              </li>
              <li>Set <var>registration</var>.<var>installing</var> to <var>worker</var>.</li>
              <li>Resolve <var>promise</var> with <var>registration</var>.</li>
              <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>registration</var>.<var>installing</var> and "<code>installing</code>" as the arguments.</li>
              <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#queue-a-task">Queue a task</a> to <a href="http://goo.gl/bCI1X0">fire a simple event named</a> <code>updatefound</code> at all the <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> objects, associated with the <a href="#dfn-registration">registration</a> represented by <var>registration</var>, for all the <a href="http://www.whatwg.org/specs/web-apps/current-work/#browsing-context">browsing contexts</a>' <a href="http://dom.spec.whatwg.org/#document">Document</a> objects.</li>
              <li><a href="http://www.whatwg.org/specs/web-apps/current-work/#queue-a-task">Queue a task</a> to run the following substeps:
                <ol>
                  <li><a href="http://goo.gl/xsVftM">Fire an event</a> named <code>install</code> using <a href="#install-event-interface">InstallEvent</a> interface at the associated <code><a href="#service-worker-global-scope">ServiceWorkerGlobalScope</a></code> object.</li>
                  <li>For each <a href="http://dom.spec.whatwg.org/#concept-event-listener">event listener</a> <a href="http://dom.spec.whatwg.org/#concept-event-listener-invoke">invoked</a>:
                    <ol>
                      <li>If any uncaught runtime script error occurs, then:
                        <ol>
                          <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#report-the-error">Report the error</a> for the script per the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/workers.html#runtime-script-errors-0">runtime script errors handling</a>.</li>
                          <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>registration</var>.<var>installing</var> and "<code>redundant</code>" as the arguments.</li>
                          <li>Set <var>registration</var>.<var>installing</var> to null.</li>
                          <li>Abort these steps.</li>
                        </ol>
                      </li>
                      <li>Let <var>event</var> be the event for which this <a href="http://dom.spec.whatwg.org/#concept-event-listener">event listener</a> was invoked.</li>
                      <li>If <var>event</var>'s <a href="#extend-lifetime-flag">extend lifetime flag</a> is set, then:
                        <ol>
                          <li>Wait until <var>event</var>'s <a href="#extend-lifetime-flag">extend lifetime flag</a> is unset.</li>
                          <li>If <var>event</var>'s <a href="#wait-until-reject-flag">wait-until reject flag</a> is set, then:
                            <ol>
                              <li>Set <var>installFailed</var> to true.</li>
                            </ol>
                          </li>
                        </ol>
                      </li>
                      <li>If <var>event</var>'s <a href="">activate immediate flag</a> is set, then:
                        <ol>
                          <li>Set <var>activateImmediate</var> to true.</li>
                        </ol>
                      </li>
                    </ol>
                  </li>
                </ol>
              </li>
            </ol>
          </li>
          <li>Wait for the <a href="http://www.whatwg.org/specs/web-apps/current-work/#concept-task">task</a> queued by the step 4.1.5 to have executed.</li>
          <li>Run the following substeps atomically:
            <ol>
              <li>If <var>registration</var>.<var>installing</var> is null, then:
                <ol>
                  <li>Abort these steps.</li>
                </ol>
              </li>
              <li>If <var>installFailed</var> is true, then:
                <ol>
                  <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>registration</var>.<var>installing</var> and "<code>redundant</code>" as the arguments.</li>
                  <li>Set <var>registration</var>.<var>installing</var> to null.</li>
                  <li>Abort these steps.</li>
                </ol>
              </li>
              <li>If <var>registration</var>.<var>waiting</var> is not null, then:
                <ol>
                  <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>registration</var>.<var>waiting</var> and "<code>redundant</code>" as the arguments.</li>
                </ol>
              </li>
              <li>Set <var>registration.waiting</var> to <var>registration.installing</var>.</li>
              <li>Set <var>registration.installing</var> to null.</li>
              <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>registration</var>.<var>waiting</var> and "<code>installed</code>" as the arguments.</li>
              <li>If <var>activateImmediate</var> is true, then:
                <ol>
                  <li>For each document matching <var>registration</var>.<var>scope</var>:
                    <ol>
                      <li>Set <var>registration</var> to the document's <a href="#dfn-registration">registration</a>.</li>
                    </ol>
                  </li>
                  <li>Run <a href="#activation-algorithm">[[Activate]]</a> algorithm, or its <a href="#dfn-processing-equivalence">equivalent</a>, passing <var>registration</var> as the argument.</li>
                  <li>Abort these steps.</li>
                </ol>
              </li>
            </ol>
          </li>
          <li>Wait until no document is <a href="#dfn-document-use">using</a> <var>registration</var> as their <a href="#dfn-registration">registration</a>.</li>
          <li>Invoke <a href="#activation-algorithm">[[Activate]]</a> algorithm, or its <a href="#dfn-processing-equivalence">equivalent</a>, with <var>registration</var> as its argument.</li>
        </ol>
      </li>
      <li>Return <var>promise</var>.</li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="activation-algorithm">
    <h1>[[Activate]]</h1>

    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>registration</var>, a <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object</dd>
      <dt>Output</dt>
        <dd>None</dd>
    </dl>
    <ol>
      <li>Run the following substeps atomically:
        <ol>
          <li>Let <var>activateFailed</var> be false.</li>
          <li>Let <var>activatingWorker</var> be <var>registration</var>.<var>waiting</var>.</li>
          <li>Let <var>exitingWorker</var> be <var>registration</var>.<var>active</var>.</li>
          <li>If <var>exitingWorker</var> is not null, then:
            <ol>
              <li>Wait for <var>exitingWorker</var> to finish handling any in-progress requests.
              </li>
              <li><a href="http://goo.gl/fkJaja">Terminate</a> <var>exitingWorker</var>.</li>
              <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>exitingWorker</var> and "<code>redundant</code>" as the arguments.</li>
            </ol>
          </li>
          <li>Set <var>registration</var>.<var>active</var> to <var>activatingWorker</var>.</li>
          <li>Set <var>registration</var>.<var>waiting</var> to null.</li>
          <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>registration</var>.<var>active</var> and "<code>activating</code>" as the arguments.</li>
          <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#queue-a-task">Queue a task</a> to <a href="http://goo.gl/bCI1X0">fire a simple event named</a> <code>controllerchange</code> at <code><a href="#navigator-service-worker-attribute">navigator.serviceWorker</a></code> for all documents that have <a href="#dfn-document-use">used</a> <var>registration</var> as its <a href="#dfn-registration">registration</a>.</li>
          <li><a href="http://www.whatwg.org/specs/web-apps/current-work/#queue-a-task">Queue a task</a> to run the following substeps:
            <ol>
              <li><a href="http://goo.gl/xsVftM">Fire an event</a> named <code>activate</code> using <a href="#install-phase-event-interface">InstallPhaseEvent</a> interface at the associated <code><a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> object.</li>
              <li>For each <a href="http://dom.spec.whatwg.org/#concept-event-listener">event listener</a> <a href="http://dom.spec.whatwg.org/#concept-event-listener-invoke">invoked</a>:
                <ol>
                  <li>If any uncaught runtime script error occurs, then:
                    <ol>
                      <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#report-the-error">Report the error</a> for the script per the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/workers.html#runtime-script-errors-0">runtime script errors handling</a>.</li>
                      <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>registration</var>.<var>active</var> and "<code>redundant</code>" as the arguments.</li>
                      <li>Set <var>registration</var>.<var>active</var> to null.</li>
                      <li>Abort these steps.</li>
                    </ol>
                  </li>
                  <li>Let <var>event</var> be the event for which this <a href="http://dom.spec.whatwg.org/#concept-event-listener">event listener</a> was invoked.</li>
                  <li>If <var>event</var>'s <a href="#extend-lifetime-flag">extend lifetime flag</a> is set, then:
                    <ol>
                      <li>Wait until <var>event</var>'s <a href="#extend-lifetime-flag">extend lifetime flag</a> is unset.</li>
                      <li>If <var>event</var>'s <a href="#wait-until-reject-flag">wait-until reject flag</a> is set, then:
                        <ol>
                          <li>Set <var>activateFailed</var> to true</a>.</li>
                        </ol>
                      </li>
                    </ol>
                  </li>
                </ol>
              </li>
            </ol>
          </li>
        </ol>
      </li>
      <li>Wait for the <a href="http://www.whatwg.org/specs/web-apps/current-work/#concept-task">task</a> queued by the step 1.9 to have executed.</li>
      <li>Run the following substeps atomically:
        <ol>
          <li>If <var>activateFailed</var> is true, then:
            <ol>
              <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>registration</var>.<var>active</var> and "<code>redundant</code>" as the arguments.</li>
              <li>Set <var>registration</var>.<var>active</var> to null.</li>
              <li>Abort these steps.</li>
            </ol>
          </li>
          <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>registration</var>.<var>active</var> and "<code>activated</code>" as the arguments.</li>
        </ol>
      </li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="on-fetch-request-algorithm">
    <h1>[[HandleFetch]]</h1>

    <p>The <a href="#on-fetch-request-algorithm">[[HandleFetch]]</a> algorithm is the entry point for the <a href="http://goo.gl/fGMifs">fetch</a> handling handed to the Service Worker context. The invocation of <dfn id="handle-a-fetch" title="Handle a fetch">handle a fetch</dfn> with <var>request</var> must act as if the caller immediately invoked <a href="#on-fetch-request-algorithm">[[HandleFetch]]</a> algorithm with <var>request</var>.</p>

    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>request</var>, a <a href="http://fetch.spec.whatwg.org/#concept-request">request</a></dd>
      <dt>Output</dt>
        <dd><var>response</var>, a <a href="http://fetch.spec.whatwg.org/#concept-response">response</a></dd>
    </dl>
    <ol>
      <li>Let <var>handleFetchFailed</var> be false.</li>
      <li>Let <var>respondWithEntered</var> be false.</li>
      <li>Let <var>r</var> be a new <code><a href="http://fetch.spec.whatwg.org/#request">Request</a></code> object associated with <var>request</var>.</li>
      <li>Let <var>response</var> be null.</li>
      <li>Let <var>registration</var> be null.</li>
      <li>Let <var>document</var> be the <a href="http://www.whatwg.org/specs/web-apps/current-work/#responsible-document">responsible document</a> specified by the <a href="http://www.whatwg.org/specs/web-apps/current-work/#relevant-settings-object-for-a-global-object">relevant settings object</a> for <var>request</var>'s <a href="http://fetch.spec.whatwg.org/#concept-request-client">client</a>.</li>
      <li>If <var>request</var>'s <var><a href="http://fetch.spec.whatwg.org/#concept-request-context">context</a></var> is <em>navigate</em>, then:
        <ol>
          <li>If the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#navigate">navigation</a> triggering <var>request</var> was initiated with a <kdb>shift</kdb>+reload or equivalent, then:
            <ol>
              <li>Return null.</li>
            </ol>
          </li>
          <li>Set <var>registration</var> to the result of running <a href="#scope-match-algorithm">[[MatchScope]]</a> algorithm, or its <a href="#dfn-processing-equivalence">equivalent</a>, passing <var>r</var>.<var>url</var> as the argument.</li>
        </ol>
      </li>
      <li>Else,
        <ol>
          <li>Set <var>registration</var> to the <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object <a href="#dfn-document-use">used</a> by <var>document</var>.</li>
        </ol>
      </li>
      <li>If <var>registration</var> is null, then:
        <ol>
          <li>Return null.</li>
        </ol>
      </li>
      <li>If <var>registration</var>.<var>active</var> is null, then:
        <ol>
          <li>Return null.</li>
        </ol>
      </li>
      <li>Let <var>matchedWorker</var> be <var>registration</var>.<var>active</var>.</li>
      <li>If <var>request</var>'s <var><a href="http://fetch.spec.whatwg.org/#concept-request-context">context</a></var> is <em>navigate</em>, then:
        <ol>
          <li>Let <var>document</var> <a href="#dfn-document-use">use</a> <var>registration</var> as its <a href="#dfn-registration">registration</a>.</li>
        </ol>
      </li>
      <li>If <var>matchedWorker</var>.<var>state</var> is "<code>activating</code>", then:
        <ol>
          <li>Wait for <var>matchedWorker</var>.<var>state</var> to become "<code>activated</code>".</li>
          <li>If <var>matchedWorker</var>'s activation fails, then:
            <ol>
              <li>Return null.</li>
            </ol>
          </li>
        </ol>
      </li>
      <li><a href="http://www.whatwg.org/specs/web-apps/current-work/#queue-a-task">Queue a task</a> to run the following substeps:
        <ol>
          <li><a href="http://goo.gl/xsVftM">Fire an event</a> named <code>fetch</code>, using <a href="#fetch-event-interface">FetchEvent</a> interface, with <var>request</var> attribute initialized to <var>r</var>, <var>client</var> attribute initialized to <a href="http://goo.gl/2Rv6NZ">client</a> of the <var>request</var>, in the form of <a href="#service-worker-client-interface">ServiceWorkerClient</a> object, <var>context</var> attribute initialized to <a href="http://goo.gl/ivocT8">context</a> of the <var>request</var> in string, and <var>isReload</var> initialized to <code>true</code> if event was dispatched with the user's intention for the page reload, and <code>false</code> otherwise, at the associated <code><a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> object.</li>
          <li>For each <a href="http://dom.spec.whatwg.org/#concept-event-listener">event listener</a> <a href="http://dom.spec.whatwg.org/#concept-event-listener-invoke">invoked</a>:
            <ol>
              <li>If any uncaught runtime script error occurs, then:
                <ol>
                  <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#report-the-error">Report the error</a> for the script per the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/workers.html#runtime-script-errors-0">runtime script errors handling</a>.</li>
                  <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>registration</var>.<var>installing</var> and "<code>redundant</code>" as the arguments.</li>
                  <li>Set <var>registration</var>.<var>installing</var> to null.</li>
                  <li>Abort these steps.</li>
                </ol>
              </li>
              <li>Let <var>event</var> be the event for which this <a href="http://dom.spec.whatwg.org/#concept-event-listener">event listener</a> was invoked.</li>
              <li>If <var>event</var>'s <a href="#respond-with-entered-flag">respond-with entered flag</a> is set, then:
                <ol>
                  <li>Set <var>respondWithEntered</var> to true.</li>
                </ol>
              </li>
              <li>If <var>event</var>'s <a href="#wait-to-respond-flag">wait to respond flag</a> is set, then:
                <ol>
                  <li>Wait until <var>event</var>'s <a href="#wait-to-respond-flag">wait to respond flag</a> is unset.</li>
                  <li>If <var>event</var>'s <a href="#respond-with-error-flag">respond-with error flag</a> is set, then:
                    <ol>
                      <li>Set <var>handleFetchFailed</var> to true.</li>
                    </ol>
                  </li>
                  <li>Else:
                    <ol>
                      <li>Set <var>response</var> to the value, which the argument passed into the <var>event</var>'s <code><a href="#fetch-event-respondwith-method">respondWith(<var>r</var>)</a></code> method resolved with.</li>
                    </ol>
                  </li>
                </ol>
              </li>
            </ol>
          </li>
        </ol>
      </li>
      <li>Wait for the <a href="http://www.whatwg.org/specs/web-apps/current-work/#concept-task">task</a> queued by the previous step to have executed.</li>
      <li>If <var>respondWithEntered</var> is false, then:
        <ol>
          <li>Return null and run the following substeps asynchronously.</li>
          <li>If <var>request</var>'s <var><a href="http://fetch.spec.whatwg.org/#concept-request-context">context</a></var> is <em>navigate</em>, then:
            <ol>
              <li>Invoke <a href="#soft-update-algorithm">[[SoftUpdate]]</a> algorithm, or its <a href="#dfn-processing-equivalence">equivalent</a>, with <var>registration</var>.</li>
            </ol>
          </li>
          <li>Abort these steps.</li>
        </ol>
      </li>
      <li>If <var>handleFetchFailed</var> is true, then:
        <ol>
          <li>Return a <a href="http://goo.gl/jprjjc">network error</a>.</li>
        </ol>
      </li>
      <li>Else:
        <ol>
          <li>Return a <a href="http://goo.gl/7F83ei">response</a> represented by <var>response</var> and run the following substeps asynchronously.</li>
          <li>If <var>request</var>'s <var><a href="http://fetch.spec.whatwg.org/#concept-request-context">context</a></var> is <em>navigate</em>, then:
            <ol>
              <li>Invoke <a href="#soft-update-algorithm">[[SoftUpdate]]</a> algorithm, or its <a href="#dfn-processing-equivalence">equivalent</a>, with <var>registration</var>.</li>
            </ol>
          </li>
        </ol>
      </li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="on-document-unload-algorithm">
    <h1>[[HandleDocumentUnload]]</h1>

    <p>The user agent must run these steps, or their <a href="#dfn-processing-equivalence">equivalent</a>, when it <a href="http://www.whatwg.org/specs/web-apps/current-work/#unload-a-document">unloads a document</a>.</p>

    <spec-algorithm>
    <dl>
    <dt>Input</dt>
        <dd><var>document</var>, a document <a href="#dfn-document-use">using</a> the given <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object as its <a href="#dfn-registration">registration</a></dd>
    <dt>Output</dt>
        <dd>None</dd>
    </dl>
    <ol>
      <li>Run the following steps atomically.</li>
      <li>Let <var>registration</var> be the <a href="#dfn-registration">registration</a> <a href="#dfn-document-use">used</a> by <var>document</var>.</li>
      <li>If <var>registration</var> is null, then:
        <ol>
          <li>Abort these steps.</li>
        </ol>
      </li>
      <li>If any other document is <a href="#dfn-document-use">using</a> <var>registration</var> as their <a href="#dfn-registration">registration</a>, then:
        <ol>
          <li>Abort these steps.</li>
        </ol>
      </li>
      <li>If <var>registration</var>.<a href="#upinstalling-internal-property">[[Uninstalling]]</a> is true, then:
        <ol>
          <li>Invoke <a href="#clear-registration-algorithm">[[ClearRegistration]]</a> algorithm passing <var>registration</var> as its argument.</li>
          <li>Abort these steps.</li>
        </ol>
      </li>
      <li>If <var>registration</var>.<var>waiting</var> is not null:
        <ol>
          <li>Run <a href="#activation-algorithm">[[Activate]]</a> algorithm, or its <a href="#dfn-processing-equivalence">equivalent</a>, with <var>registration</var> at the argument.</li>
        </ol>
      </li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="unregister-algorithm">
    <h1>[[Unregister]]</h1>

    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>document</var>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#the-document-object"><code>Document</code></a></dd>
        <dd><var>scope</var>, a string that represents a <a href="#dfn-path-prefix">path prefix</a> or a <a href="#dfn-url-scope">URL scope</a></dd>
      <dt>Output</dt>
        <dd><var>promise</var>, a <a href="http://goo.gl/3TobQS">promise</a></dd>
    </dl>
    <ol>
      <li>Let <var>promise</var> be a new <a href="http://goo.gl/3TobQS">promise</a>.</li>
      <li>Let <var>scope</var> be the result of running the <a href="http://url.spec.whatwg.org/#concept-url-parser">URL parser</a> on <var>scope</var> with <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#entry-settings-object">entry settings object</a>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/#api-base-url">API base URL</a>.</li>
      <li>Set <var>scope</var> to the result of running the <a href="http://url.spec.whatwg.org/#concept-url-serializer">URL serializer</a> on <var>scope</var> with the <a href="#FIXME(jungkees):to-the-exclude-fragment-flag-in-Fetch">exclude fragment flag</a> set.</li>
      <li>Run the following substeps asynchronously:
        <ol>
          <li>If the <a href="http://www.whatwg.org/specs/web-apps/current-work/#origin">origin</a> of <var>scope</var> does not match <var>document</var>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/#origin">origin</a>, then:
            <ol>
              <li>Reject <var>promise</var> with a "<code><a href="http://dom.spec.whatwg.org/#securityerror">SecurityError</a></code>" exception.</li>
              <li>Abort these steps.</li>
            </ol>
          </li>
          <li>Run the following substeps atomically:
            <ol>
              <li>Let <var>registration</var> be the result of running <a href="#get-registration-algorithm">[[GetRegistration]]</a> algorithm passing <var>scope</var> as the argument.</li>
              <li>If <var>registration</var> is null, then:
                <ol>
                  <li>Resolve <var>promise</var> with false.</li>
                  <li>Abort these steps.</li>
                </ol>
              </li>
              <li>Set <var>registration</var>.<a href="#upinstalling-internal-property">[[Uninstalling]]</a> to true.</li>
              <li>Resolve <var>promise</var> with true.</li>
              <li>If no document is <a href="#dfn-document-use">using</a> <var>registration</var> as their <a href="#dfn-registration">registration</a>, then:
                <ol>
                  <li>If <var>registration</var>.<a href="#upinstalling-internal-property">[[Uninstalling]]</a> is false, then:
                    <ol>
                      <li>Abort these steps.</li>
                    </ol>
                  </li>
                  <li>Invoke <a href="#clear-registration-algorithm">[[ClearRegistration]]</a> algorithm passing <var>registration</var> as its argument.</li>
                </ol>
              </li>
            </ol>
          </li>
        </ol>
      </li>
      <li>Return <var>promise</var>.</li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="set-registration-algorithm">
    <h1>[[SetRegistration]]</h1>

    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>scope</var>, a string that represents a <a href="#dfn-path-prefix">path prefix</a> or a <a href="#dfn-url-scope">URL scope</a></dd>
      <dt>Output</dt>
        <dd><var>registration</var>, a <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object</dd>
    </dl>
    <ol>
      <li>Run the following steps atomically.</li>
      <li>Let <var>registration</var> be a new <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object.</li>
      <li>Set a newly-created Record {[[key]]: <var>scope</var>, [[value]]: <var>registration</var>} to <a href="#service-worker-registration-map-internal-interface">[[ScopeToRegistrationMap]]</a>.</li>
      <li>Set <var>registration</var>.<var>scope</var> to <var>scope</var>.</li>
      <li>Return <var>registration</var>.</li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="clear-registration-algorithm">
    <h1>[[ClearRegistration]]</h1>

    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>registration</var>, a <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object</dd>
      <dt>Output</dt>
        <dd>None</dd>
    </dl>
    <ol>
      <li>Run the following steps atomically.</li>
      <li>If <var>registration</var>.<var>installing</var> is not null, then:
        <ol>
          <li><a href="http://goo.gl/fkJaja">Terminate</a> <var>registration</var>.<var>installing</var>.</li>
          <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>registration</var>.<var>installing</var> and "<code>redundant</code>" as the arguments.</li>
          <li>Set <var>registration</var>.<var>installing</var> to null.</li>
          <li>The user agent may abort in-flight requests triggered by <var>registration</var>.<var>installing</var>.</li>
        </ol>
      </li>
      <li>If <var>registration</var>.<var>waiting</var> is not null, then:
        <ol>
          <li><a href="http://goo.gl/fkJaja">Terminate</a> <var>registration</var>.<var>waiting</var>.</li>
          <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>registration</var>.<var>waiting</var> and "<code>redundant</code>" as the arguments.</li>
          <li>Set <var>registration</var>.<var>waiting</var> to null.</li>
          <li>The user agent may abort in-flight requests triggered by <var>registration</var>.<var>waiting</var>.</li>
        </ol>
      </li>
      <li>If <var>registration</var>.<var>active</var> is not null, then:
        <ol>
          <li><a href="http://goo.gl/fkJaja">Terminate</a> <var>registration</var>.<var>active</var>.</li>
          <li>Run the <a href="#update-state-algorithm">[[UpdateState]]</a> algorithm passing <var>registration</var>.<var>active</var> and "<code>redundant</code>" as the arguments.</li>
          <li>Set <var>registration</var>.<var>active</var> to null.</li>
          <li>The user agent may abort in-flight requests triggered by <var>registration</var>.<var>active</var>.</li>
        </ol>
      </li>
      <li>Delete a Record {[[key]], [[value]]} <var>entry</var> of its <var><a href="#service-worker-registration-map-internal-interface">[[ScopeToRegistrationMap]]</a></var> where <var>registration</var>.<var>scope</var> matches <var>entry</var>.[[key]].</li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="update-state-algorithm">
    <h1>[[UpdateState]]</h1>

    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>worker</var>, a <code><a href="#service-worker-interface">ServiceWorker</a></code> object</dd>
        <dd><var>state</var>, a <a href="#service-worker-state-enum">state</a></dd>
      <dt>Output</dt>
        <dd>None</dd>
    </dl>
    <ol>
      <li>Let <var>serviceWorkers</var> be an array containing all the <code><a href="#service-worker-interface">ServiceWorker</a></code> objects, associated with the <a href="#dfn-service-worker">Service Worker</a> represented by <var>worker</var>, for all the <a href="http://www.whatwg.org/specs/web-apps/current-work/#browsing-context">browsing contexts</a>' <a href="http://dom.spec.whatwg.org/#document">Document</a> objects and the <code><a href="#service-worker-global-scope-interface">ServiceWorkerGlobalScope</a></code> object represented by <var>worker</var>.</li>
      <li>For each <var>serviceWorker</var> in <var>serviceWorkers</var>:
        <ol>
          <li><a href="http://www.whatwg.org/specs/web-apps/current-work/#queue-a-task">Queue a task</a> to run these steps:
            <ol>
              <li>Set <var>serviceWorker</var>.<var>state</var> to <var>state</var>.</li>
              <li><a href="http://goo.gl/bCI1X0">Fire a simple event named</a> <code>statechange</code> at <var>serviceWorker</var>.</li>
            </ol>
          </li>
        </ol>
      </li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="scope-match-algorithm">
    <h1>[[MatchScope]]</h1>

    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>scope</var>, a string that represents a <a href="#dfn-url-scope">URL scope</a></dd>
      <dt>Output</dt>
        <dd><var>registration</var>, a <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object</dd>
    </dl>
    <ol>
      <li>Run the following steps atomically.</li>
      <li>Let <var>matchingScope</var> be the longest [[key]] in <a href="#service-worker-registration-map-internal-interface">[[ScopeToRegistrationMap]]</a> starting with the value of <var>scope</var>.</li>
      <li>Let <var>registration</var> be the result of running <a href="#get-registration-algorithm">[[GetRegistration]]</a> algorithm passing <var>matchingScope</var> as the argument.</li>
      <li>If <var>registration</var> is not null and <var>registration</var>.<a href="#upinstalling-internal-property">[[Uninstalling]]</a> is true, then:
        <ol>
          <li>Return null.</li>
        </ol>
      </li>
      <li>Return <var>registration</var>.</li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="get-registration-algorithm">
    <h1>[[GetRegistration]]</h1>

    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>scope</var>, a string that represents a <a href="#dfn-url-scope">URL scope</a></dd>
      <dt>Output</dt>
        <dd><var>registration</var>, a <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object</dd>
    </dl>
    <ol>
      <li>Run the following steps atomically.</li>
      <li>Let <var>registration</var> be null.</li>
      <li>For each Record {[[key]], [[value]]} <var>entry</var> of its <a href="#service-worker-registration-map-internal-interface">[[ScopeToRegistrationMap]]</a>:
        <ol>
          <li>If <var>scope</var> matches <var>entry</var>.[[key]], then:
            <ol>
              <li>Set <var>registration</var> to <var>entry</var>.[[value]].</li>
            </ol>
          </li>
        </ol>
      </li>
      <li>Return <var>registration</var>.</li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="get-newest-worker-algorithm">
    <h1>[[GetNewestWorker]]</h1>

    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>registration</var>, a <code><a href="#service-worker-registration-interface">ServiceWorkerRegistration</a></code> object</dd>
      <dt>Output</dt>
        <dd><var>worker</var>, a <code><a href="#service-worker-interface">ServiceWorker</a></code> object</dd>
    </dl>
    <ol>
      <li>Run the following steps atomically.</li>
      <li>Let <var>newestWorker</var> be null.</li>
      <li>If <var>registration</var>.<var>installing</var> is not null, then:
        <ol>
          <li>Set <var>newestWorker</var> to <var>registration</var>.<var>installing</var>.</li>
        </ol>
      </li>
      <li>Else if <var>registration</var>.<var>waiting</var> is not null, then:
        <ol>
          <li>Set <var>newestWorker</var> to <var>registration</var>.<var>waiting</var>.</li>
        </ol>
      </li>
      <li>Else if <var>registration</var>.<var>active</var> is not null, then:
        <ol>
          <li>Set <var>newestWorker</var> to <var>registration</var>.<var>active</var>.</li>
        </ol>
      </li>
      <li>Return <var>newestWorker</var>.</li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="query-cache-algorithm">
    <h1>[[QueryCache]]</h1>

    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>request</var>, a <code><a href="http://fetch.spec.whatwg.org/#request">Request</a></code> object</dd>
        <dd><var>params</var>, a <code><a href="#query-params-dictionary">QueryParams</a></code> object, optional</dd>
      <dt>Output</dt>
        <dd><var>resultArray</var>, an array that has [<code><a href="http://fetch.spec.whatwg.org/#request">Request</a></code>, <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code>] pairs as its elements</dd>
    </dl>
    <ol>
      <li>Let <var>requestArray</var> be an empty array.</li>
      <li>Let <var>responseArray</var> be an empty array.</li>
      <li>Let <var>request</var> be the result of invoking the initial value of <a href="http://fetch.spec.whatwg.org/#dom-request">Request</a> as constructor with <var>request</var> as the argument.</li>
      <li>If this <a href="http://dom.spec.whatwg.org/#concept-throw">throws</a> an exception, then:
        <ol>
          <li>Rethrow that exception.</li>
          <li>Abort these steps.</li>
        </ol>
      </li>
      <li>If <var>params</var>.<var>ignoreMethod</var> is false and <var>request</var>.<var>method</var> is neither "GET" nor "HEAD", then:
        <ol>
          <li>Return <var>responseArray</var>.</li>
        </ol>
      </li>
      <li>For each Record {[[key]], [[value]]} <var>entry</var> of its <a href="#request-to-response-map-internal-interface">[[RequestToResponseMap]]</a>:
        <ol>
          <li>Let <var>cachedURL</var> be <var>entry</var>.[[key]].<var>url</var>.</li>
          <li>Let <var>requestURL</var> be <var>request</var>.<var>url</var>.</li>
          <li>If <var>params</var>.<var>ignoreSearch</var> is true, then:
            <ol>
              <li>Set <var>cachedURL</var>.<var>search</var> to the empty string.</li>
              <li>Set <var>requestURL</var>.<var>search</var> to the empty string.</li>
            </ol>
          </li>
          <li>If <var>params</var>.<var>prefixMatch</var> is true, then:
            <ol>
              <li>Set <var>cachedURL</var>.<var>href</var> to the substring of itself from the start, with the length of <var>requestURL</var>.<var>href</var>.</li>
            </ol>
          </li>
          <li>If <var>cachedURL</var>.<var>href</var> matches <var>requestURL</var>.<var>href</var>, then:
            <ol>
              <li>Add <var>entry</var>.[[key]] to <var>requestArray</var>.</li>
              <li>Add <var>entry</var>.[[value]] to <var>responseArray</var>.</li>
            </ol>
          </li>
        </ol>
      </li>
      <li>Let <var>resultArray</var> be an empty array.</li>
      <li>For each <var>cachedResponse</var> in <var>responseArray</var> with the index <var>index</var>:
        <ol>
          <li>Let <var>cachedRequest</var> be the <var>index</var>th element in <var>requestArray</var>.</li>
          <li>If the result of running <var>cachedResponse</var>.<var><a href="http://fetch.spec.whatwg.org/#dom-response-headers">headers</a></var> object's <code><a href="http://fetch.spec.whatwg.org/#dom-headers-has">has(<var>name</var>)</a></code> method with "Vary" as the argument is false, or <var>params</var>.<var>ignoreVary</var> is true, then:
            <ol>
              <li>Add an array [<var>cachedRequest</var>, <var>cachedResponse</var>] to <var>resultArray</var>.</li>
            </ol>
          </li>
          <li>Let <var>varyHeaders</var> be the array containing the elements corresponding to the <a href="http://tools.ietf.org/html/rfc2616#section-4.2">field-values</a> of the <a href="http://tools.ietf.org/html/rfc2616#section-14.44">Vary</a> header.</li>
          <li>For each <var>f</var> in <var>varyHeaders</var>:
            <ol>
              <li>If <var>f</var> matches "*", then:
                <ol>
                  <li>Continue to the next iteration of the loop.</li>
                </ol>
              </li>
              <li>If the result of running <var>cachedRequest</var>.<var><a href="http://fetch.spec.whatwg.org/#dom-request-headers">headers</a></var> object's <code><a href="http://fetch.spec.whatwg.org/#dom-headers-get">get(<var>name</var>)</a></code> method with <var>f</var> as the argument does not match the result of running <var>request</var>.<var><a href="http://fetch.spec.whatwg.org/#dom-request-headers">headers</a></var> object's <code><a href="http://fetch.spec.whatwg.org/#dom-headers-get">get(<var>name</var>)</a></code> method with <var>f</var> as the argument, then:
                <ol>
                  <li>Break the loop.</li>
                </ol>
              </li>
              <li>Add an array [<var>cachedRequest</var>, <var>cachedResponse</var>] to <var>resultArray</var>.</li>
            </ol>
          </li>
        </ol>
      </li>
      <li>Return <var>resultArray</var>.</li>
    </ol>
    </spec-algorithm>
  </spec-section>

  <spec-section id="batch-cache-operations-algorithm">
    <h1>[[BatchCacheOperations]]</h1>

    <spec-algorithm>
    <dl>
      <dt>Input</dt>
        <dd><var>operations</var>, an array of  <code><a href="cache-batch-operation-dictionary">CacheBatchOperation</a></code> dictionary objects</dd>
      <dt>Output</dt>
        <dd><var>q</var>, a <a href="http://goo.gl/3TobQS">promise</a> resolves with an array of <code><a href="http://fetch.spec.whatwg.org/#response">Response</a></code> objects.</dd>
    </dl>
    <ol>
      <li>Let <var>p</var> be a <a href="http://goo.gl/3TobQS">promise</a> resolved with no value.</li>
      <li>Let <var>q</var> be <a href="https://github.com/domenic/promises-unwrapping/blob/master/docs/writing-specifications-with-promises.md#manipulating-promises">transforming <var>p</var> with <var>onFulfilled</var></a>.</li>
      <li><a href="https://github.com/w3ctag/promises-guide#reacting-to-promises">Upon fulfillment of <var>p</var> with value <var>v</var></a>, perform the following substeps, <var>onFulfilled</var>, asynchronously:
        <ol>
          <li>Let <var>itemsCopy</var> be a new <a href="http://localhost/spec/service_worker/#request-to-response-map-internal-interface">[[RequestToResponseMap]]</a> object that is a copy of its <a href="http://dom.spec.whatwg.org/#context-object">context object</a>'s <a href="http://localhost/spec/service_worker/#request-to-response-map-internal-interface">[[RequestToResponseMap]]</a> object.</li>
          <li>Let <var>addedRequests</var> be an empty array.</li>
          <li>Try running the following substeps atomically:
            <ol>
              <li>Let <var>resultArray</var> be an empty array.</li>
              <li>For each <var>operation</var> in <var>operations</var> with the index <var>index</var>:
                <ol>
                  <li>If <var>operation</var>.<var>type</var> matches neither "delete" nor "put", then:
                    <ol>
                      <li><a href="http://dom.spec.whatwg.org/#concept-throw">Throw</a> a TypeError.</li>
                    </ol>
                  </li>
                  <li>If <var>operation</var>.<var>type</var> matches "delete" and <var>operation</var>.<var>response</var> is not null, then:
                    <ol>
                      <li><a href="http://dom.spec.whatwg.org/#concept-throw">Throw</a> a TypeError.</li>
                    </ol>
                  </li>
                  <li>Let <var>request</var> be the result of invoking the initial value of <a href="http://fetch.spec.whatwg.org/#dom-request">Request</a> as constructor with <var>operation</var>.<var>request</var> as the argument.</li>
                  <li>Let <var>requestResponseArray</var> be the result of running <a href="#query-cache-algorithm">[[QueryCache]]</a> algorithm passing <var>request</var> and <var>operation</var>.<var>matchParams</var> as the arguments.</li>
                  <li>For each <var>requestResponse</var> in <var>requestResponseArray</var>:
                    <ol>
                      <li>If any of the values in <var>addedRequests</var> matches <var>requestResponse</var>[0], then:
                        <ol>
                          <li><a href="http://dom.spec.whatwg.org/#concept-throw">Throw</a> an "<code><a href="http://dom.spec.whatwg.org/#invalidstateerror">InvalidStateError</a></code>" exception.</li>
                        </ol>
                      </li>
                      <li>For each Record {[[key]], [[value]]} <var>entry</var> of its <a href="#request-to-response-map-internal-interface">[[RequestToResponseMap]]</a>:
                        <ol>
                          <li>If <var>requestResponse</var>[0] matches <var>entry</var>.[[key]], then:
                          <ol>
                            <li>Delete <var>entry</var>.</li>
                          </ol>
                        </li>
                        </ol>
                      </li>
                    </ol>
                  </li>
                  <li>If <var>operation</var>.<var>type</var> matches "put", then:
                    <ol>
                      <li>If <var>operation</var>.<var>response</var> is null, then:
                        <ol>
                          <li><a href="http://dom.spec.whatwg.org/#concept-throw">Throw</a> a TypeError.</li>
                        </ol>
                      </li>
                      <li>If <var>request</var>.<var>method</var> does not match "GET", then:
                        <ol>
                          <li><a href="http://dom.spec.whatwg.org/#concept-throw">Throw</a> a TypeError.</li>
                        </ol>
                      </li>
                      <li>If <var>operation</var>.<var>matchParams</var> is not null, then:
                        <ol>
                          <li><a href="http://dom.spec.whatwg.org/#concept-throw">Throw</a> a TypeError.</li>
                        </ol>
                      </li>
                      <li>Add <var>request</var> to <var>addedRequests</var>.</li>
                      <li>Set a newly-created Record {[[key]]: <var>request</var>, [[value]]: <var>operation</var>.<var>response</var>} to <a href="#request-to-response-map-internal-interface">[[RequestToResponseMap]]</a>.</li>
                    </ol>
                  </li>
                  <li>Add <var>operation</var>.<var>response</var> to <var>resultArray</var>.</li>
                </ol>
              </li>
              <li>Resolve <var>q</var> with <var>resultArray</var>.</li>
            </ol>
          </li>
          <li>And then, if an exception was <a href="http://dom.spec.whatwg.org/#concept-throw">thrown</a>, then:
            <ol>
              <li>Set the <a href="http://dom.spec.whatwg.org/#context-object">context object</a>'s <a href="http://localhost/spec/service_worker/#request-to-response-map-internal-interface">[[RequestToResponseMap]]</a> to <var>itemsCopy</var>.</li>
              <li>Rethrow the exception</li>
            </ol>
          </li>
        </ol>
      </li>
      <li>Return <var>q</var>.</li>
    </ol>
    </spec-algorithm>
  </spec-section>

</spec-clause>

<spec-clause id="acknowledgements">
  <h1>Acknowledgements</h1>
  <!-- FIXME: INCOMPLETE!! Please add collaborators below. -->

  <p>Jake Archibald is a ghost-author of this document. The best instincts in the design are his. He similarly shaped many of the details through discussion and experimentation. The bits which are not his (but which are good) owe everything to his experience, persistence, and focus on enabling web developers. He embodies a hopeful example for developers in shaping browser efforts to more directly address real-world pain points. If Service Workers solve "offline for the web", the credit is due him.</p>

  <p>Deep thanks go to Andrew Betts for organizing and hosting a small workshop of like-minded individuals including: Jake Archibald, Jackson Gabbard, Tobie Langel, Robin Berjon, Patrick Lauke, Christian Heilmann. From the clarity of the day's discussions and the use-cases outlined there, much has become possible. Further thanks to Andrew for raising consciousness about the offline problem. His organization of EdgeConf and inclusion of Offline as a persistent topic there has created many opportunities and connections that have enabled this work to progress.</p>

  <p>Anne van Kesteren has generously lent his encyclopedic knowledge of Web Platform arcana and standards development experience throughout the development of the Service Worker. This specification would be incomplete without his previous work in describing the real-world behavior of URLs, HTTP Fetch, Promises, and DOM. Similarly, this specification would not be possible without Ian Hickson's rigorous Web Worker spec. Much thanks to him.</p>

  <p>In no particular order, deep gratitude for design guidance and discussion goes to: Jungkee Song, Alec Flett, David Barrett-Kahn, Aaron Boodman, Michael Nordman, Tom Ashworth, Kinuko Yasuda, Darin Fisher, Jonas Sicking, Jess Legans Combarro, Mark Christian, Dave Hermann, Yehuda Katz, Franois Remy, Ilya Grigorik, Will Chan, Domenic Denicola, Nikhil Marathe, Yves Lafon, Adam Barth, Greg Simon, Devdatta Akhawe, Dominic Cooney, Jeffrey Yasskin, Joshua Bell, Boris Zbarsky, Matt Falkenhagen, Tobie Langel, and Gavin Peters.</p>

  <p>Jason Weber, Chris Wilson, Paul Kinlan, Ehsan Akhgari, and Daniel Austin have provided valuable, well-timed feedback on requirements and the standardization process.</p>

  <p>The authors would also like to thank Dimitri Glazkov for his scripts and formatting tools which have been essential in the production of this specification. The authors are also grateful for his considerable guidance.</p>

  <p>Thanks also to Vivian Cromwell, Greg Simon, Alex Komoroske, and Wonsuk Lee for their considerable professional support.</p>
</spec-clause>
</body>
</html>
